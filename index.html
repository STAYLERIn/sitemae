<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0a0c10" />
  <title>Planilha de Treino | Tracker</title>

  <style>
    :root{
      --bg:#070910;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --text:#eaf0ff;
      --muted:#a8b6d8;

      /* ‚ÄúiPhone vibe‚Äù */
      --brand:#7c5cff;
      --brand2:#37d3ff;
      --ok:#39d98a;
      --warn:#ffcc66;
      --danger:#ff5c7a;

      --ring: rgba(124,92,255,.30);
      --shadow: 0 10px 30px rgba(0,0,0,.40);
      --shadow2: 0 18px 60px rgba(0,0,0,.55);

      --r: 22px;
      --r2: 16px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", system-ui, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
    }

    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 520px at 15% -10%, rgba(124,92,255,.35), transparent 62%),
        radial-gradient(700px 420px at 85% 5%, rgba(55,211,255,.22), transparent 60%),
        radial-gradient(700px 420px at 50% 110%, rgba(57,217,138,.10), transparent 62%),
        linear-gradient(180deg, #050610, #070910 45%, #050610);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow-x:hidden;
      padding-bottom: calc(280px + env(safe-area-inset-bottom)); /* espa√ßo para o bottom sheet */
    }

    /* Container mobile-first */
    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 14px 14px 22px;
    }

    /* Top bar estilo app */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      padding-top: env(safe-area-inset-top);
      background: rgba(7,9,16,.72);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbarInner{
      max-width: 520px;
      margin: 0 auto;
      padding: 12px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .titleBlock{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width:0;
    }
    .appTitle{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .badge{
      font-size: 11px;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(90deg, rgba(124,92,255,.18), rgba(55,211,255,.14));
      color: var(--muted);
      width: fit-content;
    }
    .pill{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-family: var(--mono);
      white-space:nowrap;
    }

    /* Bot√µes: grandes e ‚Äútouch friendly‚Äù */
    button, .btn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.07);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: scale(.98); }

    .btnPrimary{
      background: linear-gradient(90deg, rgba(124,92,255,.92), rgba(55,211,255,.80));
      border-color: rgba(255,255,255,.16);
      color: #061018;
      font-weight: 800;
    }
    .btnDanger{
      border-color: rgba(255,92,122,.22);
    }

    .iconBtn{
      width: 42px;
      height: 42px;
      display:grid;
      place-items:center;
      padding:0;
      border-radius: 14px;
    }

    /* Card padr√£o */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 14px 14px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .cardHead h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .cardBody{ padding: 14px; }

    .smallText{ font-size: 12px; color: var(--muted); line-height: 1.35; }
    .hr{ height:1px; background: rgba(255,255,255,.08); margin: 12px 0; }

    /* Tabs estilo iOS com scroll horizontal */
    .tabs{
      display:flex;
      gap: 10px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 6px;
      margin-bottom: 10px;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar{ display:none; }

    .tab{
      flex: 0 0 auto;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted);
      cursor:pointer;
      background: rgba(255,255,255,.06);
      transition: .18s ease;
      font-size: 12px;
      font-weight: 650;
    }
    .tab.active{
      color: #071018;
      background: linear-gradient(90deg, rgba(57,217,138,.85), rgba(55,211,255,.78));
      border-color: rgba(255,255,255,.16);
      font-weight: 850;
    }

    /* Exerc√≠cios (accordion) */
    details{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r2);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      margin-bottom: 12px;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding: 14px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      user-select:none;
    }
    summary::-webkit-details-marker{ display:none; }

    .sumLeft{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width:0;
    }
    .exName{
      font-weight: 850;
      letter-spacing:.2px;
      font-size: 14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .exMeta{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.2;
    }
    .sumRight{
      display:flex;
      gap:8px;
      align-items:center;
      color: var(--muted);
      font-size: 11px;
      font-family: var(--mono);
      flex: 0 0 auto;
    }
    .kpi{
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      white-space:nowrap;
    }

    .exBody{
      padding: 12px 14px 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:grid;
      gap: 12px;
    }

    /* Inputs e tabela mobile-friendly */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 12px;
      vertical-align: middle;
    }
    th{
      text-align:left;
      color: var(--muted);
      font-weight: 800;
      background: rgba(0,0,0,.18);
    }
    tr:last-child td{ border-bottom:none; }

    input[type="number"]{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
      transition: .18s ease;
      font-size: 14px;
    }
    input[type="number"]:focus{
      border-color: rgba(124,92,255,.55);
      box-shadow: 0 0 0 6px var(--ring);
    }

    .mini{
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 12px;
      font-weight: 800;
    }

    /* Linha de a√ß√µes fica em coluna no mobile */
    .rowActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
    }
    .rowActions button{ flex: 1 1 48%; }

    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
      border: 1px dashed rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 10px 10px;
      background: rgba(255,255,255,.04);
    }

    /* ‚ÄúBottom sheet‚Äù do timer */
    .sheet{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
      padding: 10px 12px calc(12px + env(safe-area-inset-bottom));
      background: rgba(7,9,16,.72);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .sheetInner{
      max-width: 520px;
      margin: 0 auto;
      display:grid;
      gap: 10px;
    }
    .timerCard{
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(124,92,255,.14), rgba(0,0,0,.22));
      box-shadow: var(--shadow2);
      padding: 12px 14px;
      display:grid;
      gap: 10px;
    }
    .timerTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .timerTitle{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width:0;
    }
    .timerTitle b{
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .timerTitle span{
      font-size: 12px;
      color: var(--muted);
    }
    .time{
      font-family: var(--mono);
      font-size: 34px;
      letter-spacing: .8px;
      font-weight: 900;
      flex: 0 0 auto;
    }
    .timerBtns{
      display:flex;
      gap: 10px;
    }
    .timerBtns button{
      flex: 1 1 0;
      height: 46px;
      font-size: 13px;
      border-radius: 16px;
      font-weight: 900;
    }

    /* KPIs compactos no sheet */
    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .stat{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 10px 12px;
      background: rgba(0,0,0,.18);
    }
    .stat .label{
      color: var(--muted);
      font-size: 11px;
      margin-bottom: 6px;
      font-weight: 700;
    }
    .stat .value{
      font-family: var(--mono);
      font-size: 16px;
      font-weight: 900;
    }

    /* Hist√≥rico em card separado */
    .historyCard{
      margin-top: 12px;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      top: calc(10px + env(safe-area-inset-top));
      transform: translateX(-50%);
      background: rgba(15,20,32,.92);
      border: 1px solid rgba(255,255,255,.12);
      padding: 10px 12px;
      border-radius: 999px;
      color: var(--text);
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      font-size: 12px;
      z-index: 80;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(2px);
    }

    /* Desktop: ainda funciona, mas mobile √© prioridade */
    @media (min-width: 900px){
      .wrap{ max-width: 900px; }
      .topbarInner{ max-width: 900px; }
      .sheetInner{ max-width: 900px; }
      body{ padding-bottom: 260px; }
    }
  </style>
</head>

<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbarInner">
      <div class="titleBlock">
        <div class="appTitle">üèãÔ∏è‚Äç‚ôÇÔ∏è Planilha de Treino <span class="badge">iPhone Mode</span></div>
        <div id="todayPill" class="pill">Carregando...</div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;">
        <button id="btnExport" class="iconBtn btnPrimary" title="Exportar CSV">‚¨áÔ∏è</button>
        <button id="btnBackup" class="iconBtn" title="Backup JSON">üßæ</button>
        <label class="iconBtn btn" title="Importar JSON" style="display:grid;place-items:center;">
          üì§
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </label>
        <button id="btnReset" class="iconBtn btnDanger" title="Reset">üóëÔ∏è</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- Treino do dia -->
    <section class="card">
      <div class="cardHead">
        <h2>üìÖ Treino</h2>
        <span class="pill" id="pillTitle">Hoje</span>
      </div>
      <div class="cardBody">
        <div class="tabs" id="dayTabs"></div>
        <div class="smallText" id="dayDesc"></div>
        <div class="hr"></div>
        <div id="workoutList"></div>
      </div>
    </section>

    <!-- Hist√≥rico -->
    <section class="card historyCard">
      <div class="cardHead">
        <h2>üìà Hist√≥rico r√°pido</h2>
        <span class="pill">√∫ltimas 10</span>
      </div>
      <div class="cardBody">
        <div class="smallText">Mostra suas √∫ltimas s√©ries registradas. Exporta CSV para ver evolu√ß√£o no Excel/Sheets.</div>
        <div class="hr"></div>
        <div id="history"></div>
      </div>
    </section>
  </div>

  <!-- Bottom Sheet: TIMER + KPIs -->
  <div class="sheet">
    <div class="sheetInner">
      <div class="timerCard">
        <div class="timerTop">
          <div class="timerTitle">
            <b id="timerExercise">Nenhuma s√©rie conclu√≠da ainda</b>
            <span id="timerHint">Quando voc√™ marcar uma s√©rie como feita, o descanso come√ßa.</span>
          </div>
          <div class="time" id="timerTime">00:00</div>
        </div>

        <div class="timerBtns">
          <button id="btnStartStop">Iniciar</button>
          <button id="btnPlus20">+20s</button>
          <button id="btnResetTimer">Zerar</button>
        </div>

        <div class="kpis">
          <div class="stat">
            <div class="label">S√©ries hoje</div>
            <div class="value" id="kpiSetsToday">0</div>
          </div>
          <div class="stat">
            <div class="label">Carga total (kg)</div>
            <div class="value" id="kpiTonnageToday">0</div>
          </div>
        </div>

        <div class="stat">
          <div class="label">√öltimo registro</div>
          <div class="value" id="kpiLastLog">Nenhum</div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Salvo ‚úÖ</div>

<script>
/* =========================
   1) PLANO DE TREINO (fixo)
   ========================= */
const PLAN = {
  "Segunda": {
    title: "PUSH (Peito + Tr√≠ceps)",
    desc: "Foco em carga nos compostos e reps moderadas/altas nos isoladores para hipertrofia natural com boa recupera√ß√£o.",
    exercises: [
      { name: "Supino inclinado", target: "4x 6‚Äì8", restSec: 150, note: "Composto pesado. Progrida carga ou reps." , sets: 4, repMin: 6, repMax: 8 },
      { name: "Crucifixo na m√°quina", target: "3x 10‚Äì12", restSec: 75, note: "Controle e alongamento." , sets: 3, repMin: 10, repMax: 12 },
      { name: "Paralelas (tronco levemente √† frente)", target: "3x 8‚Äì12", restSec: 105, note: "Pode usar peso extra quando bater 12 reps." , sets: 3, repMin: 8, repMax: 12 },
      { name: "Tr√≠ceps franc√™s", target: "3x 8‚Äì10", restSec: 90, note: "Amplitude e cotovelo est√°vel." , sets: 3, repMin: 8, repMax: 10 },
      { name: "Extens√£o na polia (barra)", target: "3x 12‚Äì15", restSec: 75, note: "Finaliza√ß√£o, sem estourar o cotovelo." , sets: 3, repMin: 12, repMax: 15 }
    ]
  },

  "Ter√ßa": {
    title: "PULL (Costas + B√≠ceps)",
    desc: "Costas respondem muito bem a tens√£o e volume bem controlado. B√≠ceps com alongamento e t√©cnica limpa.",
    exercises: [
      { name: "Puxada aberta na polia", target: "4x 6‚Äì8", restSec: 150, note: "Composto. Ombros longe das orelhas." , sets: 4, repMin: 6, repMax: 8 },
      { name: "Pulldown com corda", target: "3x 10‚Äì12", restSec: 90, note: "Pico de contra√ß√£o e controle." , sets: 3, repMin: 10, repMax: 12 },
      { name: "Remada aberta com halteres", target: "3x 8‚Äì10", restSec: 120, note: "Espessura. Tronco firme." , sets: 3, repMin: 8, repMax: 10 },
      { name: "Rosca no banco inclinado", target: "3x 8‚Äì10", restSec: 90, note: "Alongamento m√°ximo, sem roubo." , sets: 3, repMin: 8, repMax: 10 },
      { name: "Rosca Scott", target: "3x 10‚Äì12", restSec: 75, note: "Isolamento. Controle total." , sets: 3, repMin: 10, repMax: 12 }
    ]
  },

  "Quarta": {
    title: "LEGS (Quadr√≠ceps + Complementos)",
    desc: "Quadr√≠ceps com carga e volume, posterior com manuten√ß√£o, e reps altas em abdutor/adutor e panturrilha.",
    exercises: [
      { name: "Agachamento no Smith", target: "4x 6‚Äì8", restSec: 165, note: "Tens√£o no quadr√≠ceps, des√ßa controlando." , sets: 4, repMin: 6, repMax: 8 },
      { name: "Leg press 45¬∞", target: "3x 10‚Äì12", restSec: 120, note: "Amplitude segura. N√£o trave joelhos." , sets: 3, repMin: 10, repMax: 12 },
      { name: "Cadeira extensora", target: "3x 12‚Äì15", restSec: 75, note: "Finaliza√ß√£o. Segura 1s no topo." , sets: 3, repMin: 12, repMax: 15 },
      { name: "Cadeira flexora", target: "3x 10‚Äì12", restSec: 90, note: "Posterior com controle." , sets: 3, repMin: 10, repMax: 12 },
      { name: "Cadeira abdutora", target: "3x 15‚Äì20", restSec: 60, note: "M√∫sculo resistente. Reps altas." , sets: 3, repMin: 15, repMax: 20 },
      { name: "Panturrilha em p√© (m√°quina)", target: "4x 8‚Äì12", restSec: 75, note: "Pausa de 1s no pico. Des√ßa completo." , sets: 4, repMin: 8, repMax: 12 },
      { name: "Panturrilha sentada (m√°quina)", target: "3x 12‚Äì20", restSec: 60, note: "Mais reps. Controle total." , sets: 3, repMin: 12, repMax: 20 }
    ]
  },

  "Quinta": {
    title: "UPPER BODY (Peito + Costas + Ombros)",
    desc: "Dia de volume moderado na parte superior. Excelente para natural: frequ√™ncia e recupera√ß√£o equilibradas.",
    exercises: [
      { name: "Supino inclinado", target: "3x 8‚Äì10", restSec: 120, note: "Moderado. Foque t√©cnica." , sets: 3, repMin: 8, repMax: 10 },
      { name: "Crucifixo", target: "3x 12‚Äì15", restSec: 75, note: "Metab√≥lico, controle." , sets: 3, repMin: 12, repMax: 15 },
      { name: "Flex√£o (pegada fechada)", target: "2‚Äì3x 12‚Äì20", restSec: 60, note: "Quase falha na √∫ltima s√©rie." , sets: 3, repMin: 12, repMax: 20 },
      { name: "Puxada unilateral", target: "3x 10‚Äì12", restSec: 90, note: "Sinta dorsal trabalhando." , sets: 3, repMin: 10, repMax: 12 },
      { name: "Remada baixa", target: "3x 8‚Äì10", restSec: 120, note: "Espessura. Esc√°pulas controladas." , sets: 3, repMin: 8, repMax: 10 },
      { name: "Desenvolvimento (ombros)", target: "3x 6‚Äì8", restSec: 150, note: "Carga com controle. Sem dor." , sets: 3, repMin: 6, repMax: 8 },
      { name: "Eleva√ß√£o lateral na polia", target: "3x 12‚Äì15", restSec: 60, note: "Deltoide lateral gosta de reps." , sets: 3, repMin: 12, repMax: 15 }
    ]
  },

  "Sexta": {
    title: "POSTERIOR (Posterior + Complementos)",
    desc: "Posterior responde muito bem a tens√£o mec√¢nica e alongamento. Completa com extensora, adutor e panturrilhas.",
    exercises: [
      { name: "Stiff", target: "4x 6‚Äì8", restSec: 165, note: "Pesado e t√©cnico. Coluna neutra." , sets: 4, repMin: 6, repMax: 8 },
      { name: "Mesa flexora", target: "3x 8‚Äì10", restSec: 90, note: "For√ßa e controle." , sets: 3, repMin: 8, repMax: 10 },
      { name: "Cadeira flexora", target: "3x 12‚Äì15", restSec: 75, note: "Finaliza√ß√£o metab√≥lica." , sets: 3, repMin: 12, repMax: 15 },
      { name: "Cadeira extensora", target: "3x 12‚Äì15", restSec: 60, note: "Manuten√ß√£o do quad." , sets: 3, repMin: 12, repMax: 15 },
      { name: "Cadeira adutora", target: "3x 15‚Äì20", restSec: 60, note: "Reps altas. Controle." , sets: 3, repMin: 15, repMax: 20 },
      { name: "Panturrilha em p√©", target: "4x 8‚Äì12", restSec: 75, note: "Pausa no topo." , sets: 4, repMin: 8, repMax: 12 },
      { name: "Panturrilha sentada", target: "3x 15‚Äì20", restSec: 60, note: "Alta repeti√ß√£o." , sets: 3, repMin: 15, repMax: 20 }
    ]
  },

  "S√°bado": { title: "OFF / Recupera√ß√£o", desc: "Caminhada leve, mobilidade e sono. Natural cresce no descanso.", exercises: [] },
  "Domingo": { title: "OFF / Recupera√ß√£o", desc: "Se quiser, alongamento e 15‚Äì25 min de cardio leve.", exercises: [] }
};

const DAY_ORDER = ["Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo"];

/* =========================
   2) STORAGE
   ========================= */
const STORAGE_KEY = "treino_tracker_v1";
const getState = () => {
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { logs: [], ui: {} };
    return JSON.parse(raw);
  }catch(e){
    return { logs: [], ui: {} };
  }
};
const setState = (state) => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

/* =========================
   3) HELPERS
   ========================= */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

function isoToday(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function dayNameFromDate(dateObj){
  const map = ["Domingo","Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado"];
  return map[dateObj.getDay()];
}
function formatDateBR(iso){
  const [y,m,d] = iso.split("-").map(Number);
  return `${String(d).padStart(2,"0")}/${String(m).padStart(2,"0")}/${y}`;
}
function fmtTime(sec){
  sec = Math.max(0, Math.floor(sec));
  const mm = String(Math.floor(sec/60)).padStart(2,"0");
  const ss = String(sec%60).padStart(2,"0");
  return `${mm}:${ss}`;
}
function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"), 1200);
}
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

/* =========================
   4) TIMER
   ========================= */
let timer = { running:false, remaining:0, interval:null, exercise:"", defaultRest:0 };

function timerRender(){
  $("#timerExercise").textContent = timer.exercise || "Nenhuma s√©rie conclu√≠da ainda";
  $("#timerTime").textContent = fmtTime(timer.remaining);
  $("#btnStartStop").textContent = timer.running ? "Pausar" : "Iniciar";
  $("#timerHint").textContent = timer.exercise
    ? `Descanso sugerido: ${Math.round(timer.defaultRest/60)} min (ajuste se quiser).`
    : "Quando voc√™ marcar uma s√©rie como feita, o descanso come√ßa.";
}
function timerStart(){
  if(timer.running) return;
  timer.running = true;
  timer.interval = setInterval(()=>{
    timer.remaining -= 1;
    if(timer.remaining <= 0){
      timer.remaining = 0;
      timerStop();
      toast("Descanso finalizado üîî");
    }
    timerRender();
  }, 1000);
  timerRender();
}
function timerStop(){
  timer.running = false;
  if(timer.interval) clearInterval(timer.interval);
  timer.interval = null;
  timerRender();
}
function timerReset(toSec = null){
  timerStop();
  timer.remaining = (toSec !== null) ? toSec : (timer.defaultRest || 0);
  timerRender();
}
function timerAdd(sec){
  timer.remaining += sec;
  timerRender();
}

/* =========================
   5) UI RENDER
   ========================= */
let selectedDay = null;

function getLogsFor(dateISO, dayName, exName){
  const st = getState();
  return st.logs.filter(l =>
    l.dateISO === dateISO &&
    l.dayName === dayName &&
    l.exerciseName === exName
  ).sort((a,b)=> a.setIndex - b.setIndex);
}
function latestForExercise(exName){
  const st = getState();
  const logs = st.logs.filter(l => l.exerciseName === exName)
    .sort((a,b)=> b.createdAt - a.createdAt);
  return logs[0] || null;
}

function renderTabs(todayName){
  const el = $("#dayTabs");
  el.innerHTML = "";
  DAY_ORDER.forEach(day=>{
    const b = document.createElement("div");
    b.className = "tab" + (day === selectedDay ? " active" : "");
    b.textContent = day;
    b.title = (day === todayName) ? "Hoje" : "Ver treino";
    b.addEventListener("click", ()=>{
      selectedDay = day;
      renderAll();
    });
    el.appendChild(b);
  });
}

function renderWorkout(){
  const todayISO = isoToday();
  const plan = PLAN[selectedDay];
  $("#dayDesc").textContent = plan.desc;
  $("#pillTitle").textContent = plan.title;

  const container = $("#workoutList");
  container.innerHTML = "";

  if(!plan.exercises.length){
    container.innerHTML = `
      <div class="hint">
        <b>${plan.title}</b><br>
        Dia off. Se quiser: 15‚Äì25 min caminhada leve + mobilidade.
      </div>
    `;
    return;
  }

  plan.exercises.forEach(ex=>{
    const details = document.createElement("details");

    const last = latestForExercise(ex.name);
    const lastStr = last ? `${last.weight}kg x ${last.reps} (${formatDateBR(last.dateISO)})` : "sem hist√≥rico";
    const doneLogs = getLogsFor(todayISO, selectedDay, ex.name);
    const doneCount = doneLogs.length;

    const summary = document.createElement("summary");
    summary.innerHTML = `
      <div class="sumLeft">
        <div class="exName">${ex.name}</div>
        <div class="exMeta">Alvo: <b>${ex.target}</b> ‚Ä¢ Descanso: <b>${Math.round(ex.restSec/60)} min</b></div>
      </div>
      <div class="sumRight">
        <span class="kpi">${doneCount}/${ex.sets}</span>
        <span class="kpi">${lastStr}</span>
      </div>
    `;
    details.appendChild(summary);

    const body = document.createElement("div");
    body.className = "exBody";

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr>
        <th style="width:60px">#</th>
        <th style="width:42%">Peso</th>
        <th style="width:26%">Reps</th>
        <th style="width:32%">OK</th>
      </tr>
    `;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    for(let i=1;i<=ex.sets;i++){
      const prev = doneLogs.find(l => l.setIndex === i) || null;
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td style="font-family:var(--mono);font-weight:900">#${i}</td>
        <td><input type="number" step="0.5" min="0" inputmode="decimal" placeholder="kg"
              value="${prev ? prev.weight : ""}" data-field="weight" data-set="${i}"></td>
        <td><input type="number" step="1" min="0" inputmode="numeric" placeholder="reps"
              value="${prev ? prev.reps : ""}" data-field="reps" data-set="${i}"></td>
        <td style="text-align:right">
          <button class="mini ${prev ? "btnPrimary" : ""}" data-action="done" data-set="${i}">
            ${prev ? "Feito ‚úÖ" : "Marcar"}
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    table.appendChild(tbody);

    const hint = document.createElement("div");
    hint.className = "hint";
    hint.innerHTML = `
      <b>Objetivo</b><br>
      ${ex.note}<br>
      <span class="smallText">Zona de reps: ${ex.repMin}‚Äì${ex.repMax}. Quando bater o topo com t√©cnica boa, sobe 2‚Äì5% na pr√≥xima sess√£o.</span>
    `;

    const actions = document.createElement("div");
    actions.className = "rowActions";
    actions.innerHTML = `
      <button class="mini" data-action="copyLast">Usar √∫ltimo peso/reps</button>
      <button class="mini btnDanger" data-action="clearToday">Limpar hoje</button>
    `;

    body.appendChild(table);
    body.appendChild(hint);
    body.appendChild(actions);

    body.addEventListener("click", (ev)=>{
      const btn = ev.target.closest("button");
      if(!btn) return;
      const action = btn.dataset.action;
      if(action === "done"){
        const setIndex = Number(btn.dataset.set);
        onMarkSetDone(ex, setIndex, body);
      }
      if(action === "copyLast") onCopyLast(ex, body);
      if(action === "clearToday") onClearToday(ex);
    });

    details.appendChild(body);
    container.appendChild(details);
  });
}

function readInputsForSet(body, setIndex){
  const w = body.querySelector(`input[data-field="weight"][data-set="${setIndex}"]`);
  const r = body.querySelector(`input[data-field="reps"][data-set="${setIndex}"]`);
  const weight = w ? Number(w.value) : NaN;
  const reps = r ? Number(r.value) : NaN;
  return { weight, reps };
}

function onMarkSetDone(ex, setIndex, body){
  const { weight, reps } = readInputsForSet(body, setIndex);

  if(!Number.isFinite(weight) || weight <= 0){ toast("Coloque o peso ‚úÖ"); return; }
  if(!Number.isFinite(reps) || reps <= 0){ toast("Coloque as reps ‚úÖ"); return; }

  const st = getState();
  const todayISO = isoToday();

  st.logs = st.logs.filter(l => !(l.dateISO === todayISO && l.dayName === selectedDay && l.exerciseName === ex.name && l.setIndex === setIndex));

  st.logs.push({
    id: uid(),
    dateISO: todayISO,
    dayName: selectedDay,
    workoutTitle: PLAN[selectedDay].title,
    exerciseName: ex.name,
    setIndex,
    weight,
    reps,
    targetText: ex.target,
    restSec: ex.restSec,
    createdAt: Date.now()
  });

  setState(st);
  toast("S√©rie salva ‚úÖ");

  timer.exercise = ex.name;
  timer.defaultRest = ex.restSec;
  timerReset(ex.restSec);
  timerStart();

  renderAll();
}

function onCopyLast(ex, body){
  const last = latestForExercise(ex.name);
  if(!last){ toast("Sem hist√≥rico"); return; }
  for(let i=1;i<=ex.sets;i++){
    const w = body.querySelector(`input[data-field="weight"][data-set="${i}"]`);
    const r = body.querySelector(`input[data-field="reps"][data-set="${i}"]`);
    if(w && !w.value) w.value = last.weight;
    if(r && !r.value) r.value = last.reps;
  }
  toast("Preenchido ‚úÖ");
}

function onClearToday(ex){
  const st = getState();
  const todayISO = isoToday();
  const before = st.logs.length;
  st.logs = st.logs.filter(l => !(l.dateISO === todayISO && l.dayName === selectedDay && l.exerciseName === ex.name));
  setState(st);
  const removed = before - st.logs.length;
  toast(removed ? "Hoje limpo" : "Nada p/ apagar");
  renderAll();
}

function computeKPIs(){
  const st = getState();
  const todayISO = isoToday();
  const todayLogs = st.logs.filter(l => l.dateISO === todayISO);

  const setsToday = todayLogs.length;
  let tonnage = 0;
  todayLogs.forEach(l => tonnage += (Number(l.weight)||0) * (Number(l.reps)||0));

  const last = st.logs.slice().sort((a,b)=> b.createdAt - a.createdAt)[0] || null;

  $("#kpiSetsToday").textContent = setsToday.toString();
  $("#kpiTonnageToday").textContent = Math.round(tonnage).toString();
  $("#kpiLastLog").textContent = last ? `${last.exerciseName} (${last.weight}kg x ${last.reps})` : "Nenhum";
}

function renderHistory(){
  const st = getState();
  const logs = st.logs.slice().sort((a,b)=> b.createdAt - a.createdAt).slice(0, 10);

  const el = $("#history");
  if(!logs.length){
    el.innerHTML = `<div class="hint">Sem registros ainda. Marca uma s√©rie como feita que aparece aqui.</div>`;
    return;
  }

  const rows = logs.map(l => `
      <tr>
        <td>${formatDateBR(l.dateISO)}</td>
        <td>${l.dayName}</td>
        <td>${l.exerciseName}</td>
        <td style="font-family:var(--mono);font-weight:900">#${l.setIndex}</td>
        <td>${l.weight}</td>
        <td>${l.reps}</td>
      </tr>
  `).join("");

  el.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Dia</th>
          <th>Exerc√≠cio</th>
          <th>S√©rie</th>
          <th>Peso</th>
          <th>Reps</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function renderAll(){
  const today = new Date();
  const todayName = dayNameFromDate(today);
  const todayISO = isoToday();

  if(!selectedDay) selectedDay = todayName;

  $("#todayPill").textContent = `${todayName} ‚Ä¢ ${formatDateBR(todayISO)} ‚Ä¢ ${PLAN[selectedDay].title}`;

  renderTabs(todayName);
  $$("#dayTabs .tab").forEach(t=> t.classList.toggle("active", t.textContent === selectedDay));

  renderWorkout();
  computeKPIs();
  renderHistory();
  timerRender();
}

/* =========================
   6) EXPORT / BACKUP / IMPORT / RESET
   ========================= */
function safeCSV(v){
  const s = String(v ?? "");
  if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
  return s;
}

function exportCSV(){
  const st = getState();
  const logs = st.logs.slice().sort((a,b)=> a.createdAt - b.createdAt);
  if(!logs.length){ toast("Nada p/ exportar"); return; }

  const header = ["data","dia","treino","exercicio","serie","peso_kg","reps","alvo","descanso_seg"];
  const lines = [header.join(",")];

  logs.forEach(l=>{
    lines.push([
      l.dateISO,
      safeCSV(l.dayName),
      safeCSV(l.workoutTitle),
      safeCSV(l.exerciseName),
      l.setIndex,
      l.weight,
      l.reps,
      safeCSV(l.targetText),
      l.restSec
    ].join(","));
  });

  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `treino_logs_${isoToday()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("CSV ‚úÖ");
}

function backupJSON(){
  const st = getState();
  const blob = new Blob([JSON.stringify(st, null, 2)], { type: "application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `treino_backup_${isoToday()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("Backup ‚úÖ");
}

function importJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);
      if(!obj || !Array.isArray(obj.logs)) throw new Error("Formato inv√°lido");
      setState(obj);
      toast("Importado ‚úÖ");
      renderAll();
    }catch(e){
      toast("Falhou ‚ùå");
      alert("Arquivo inv√°lido. Use um backup JSON gerado pelo pr√≥prio site.");
    }
  };
  reader.readAsText(file);
}

function resetAll(){
  if(!confirm("Apagar tudo? Isso remove seus registros do navegador.")) return;
  localStorage.removeItem(STORAGE_KEY);
  timerReset(0);
  timer.exercise = "";
  timer.defaultRest = 0;
  toast("Reset ‚úÖ");
  renderAll();
}

/* =========================
   7) EVENTS
   ========================= */
$("#btnExport").addEventListener("click", exportCSV);
$("#btnBackup").addEventListener("click", backupJSON);
$("#btnReset").addEventListener("click", resetAll);

$("#importFile").addEventListener("change", (ev)=>{
  const file = ev.target.files?.[0];
  if(file) importJSON(file);
  ev.target.value = "";
});

$("#btnStartStop").addEventListener("click", ()=> timer.running ? timerStop() : timerStart());
$("#btnPlus20").addEventListener("click", ()=> timerAdd(20));
$("#btnResetTimer").addEventListener("click", ()=> timerReset(null));

/* INIT */
renderAll();
</script>
</body>
</html>
