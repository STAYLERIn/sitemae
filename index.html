<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="theme-color" content="#f6f7f4" />
<title>Treino Tracker</title>

<style>
  :root{
    --bg:#f6f7f4;               /* branco/bege */
    --card:#ffffff;
    --text:#1f2937;
    --muted:#6b7280;
    --border:#e5e7eb;

    --primary:#2f6fed;          /* azul moderno */
    --primarySoft:#e7efff;
    --ok:#16a34a;
    --danger:#ef4444;

    --radius:18px;
    --radius2:14px;
    --shadow:0 10px 24px rgba(15,23,42,.08);

    --font:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,Segoe UI,Roboto,Arial;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  *{box-sizing:border-box}
  html, body{height:100%}
  body{
    margin:0;
    font-family:var(--font);
    background: radial-gradient(900px 450px at 20% -10%, rgba(47,111,237,.12), transparent 55%),
                radial-gradient(800px 450px at 90% 0%, rgba(16,185,129,.07), transparent 55%),
                var(--bg);
    color:var(--text);
    padding-bottom: calc(88px + env(safe-area-inset-bottom));
    -webkit-font-smoothing: antialiased;
  }

  /* Topbar */
  .topbar{
    position: sticky;
    top:0;
    z-index: 20;
    padding-top: env(safe-area-inset-top);
    background: rgba(246,247,244,.82);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border-bottom: 1px solid rgba(229,231,235,.9);
  }
  .topbarInner{
    max-width: 560px;
    margin:0 auto;
    padding: 14px 14px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
  }
  .titleBlock{min-width:0}
  .appTitle{
    margin:0;
    font-size: 16px;
    font-weight: 900;
    letter-spacing: .2px;
    display:flex;
    align-items:center;
    gap: 8px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .subPill{
    margin-top:6px;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .pill{
    font-size: 11px;
    color: var(--muted);
    border: 1px solid var(--border);
    background: rgba(255,255,255,.7);
    padding: 6px 10px;
    border-radius: 999px;
    font-family: var(--mono);
  }

  .topActions{
    display:flex;
    gap:10px;
    align-items:center;
  }
  .iconBtn{
    width: 42px;
    height: 42px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.9);
    display:grid;
    place-items:center;
    cursor:pointer;
    box-shadow: 0 6px 16px rgba(15,23,42,.06);
    -webkit-tap-highlight-color: transparent;
    transition: transform .12s ease, background .18s ease;
  }
  .iconBtn:active{ transform: scale(.98); }
  .iconBtn.primary{
    background: linear-gradient(180deg, rgba(47,111,237,.18), rgba(255,255,255,.92));
    border-color: rgba(47,111,237,.25);
  }
  .iconBtn.danger{
    border-color: rgba(239,68,68,.25);
    background: linear-gradient(180deg, rgba(239,68,68,.10), rgba(255,255,255,.92));
  }

  /* Layout */
  .wrap{
    max-width: 560px;
    margin: 0 auto;
    padding: 14px 14px 20px;
  }
  .view{ display:none; }
  .view.active{ display:block; }

  .card{
    background: rgba(255,255,255,.86);
    border: 1px solid rgba(229,231,235,.9);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
    margin-bottom: 14px;
  }
  .cardHead{
    padding: 14px 14px 12px;
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap: 10px;
    border-bottom: 1px solid rgba(229,231,235,.9);
  }
  .cardHead h2{
    margin:0;
    font-size: 14px;
    letter-spacing: .2px;
    font-weight: 900;
    display:flex;
    align-items:center;
    gap: 8px;
  }
  .cardBody{ padding: 14px; }

  .muted{ color: var(--muted); }
  .smallText{ font-size: 12px; color: var(--muted); line-height: 1.35; }

  /* Day selector */
  .dayRow{
    display:flex;
    gap: 10px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  }
  .select{
    width: 100%;
    padding: 12px 12px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.95);
    font-weight: 800;
    color: var(--text);
    outline:none;
  }

  /* Exercise list */
  details.exercise{
    border: 1px solid rgba(229,231,235,.9);
    background: rgba(255,255,255,.9);
    border-radius: var(--radius2);
    overflow:hidden;
    margin-bottom: 10px;
  }
  details.exercise[open]{
    border-color: rgba(47,111,237,.22);
    box-shadow: 0 10px 18px rgba(47,111,237,.08);
  }
  summary{
    list-style:none;
    cursor:pointer;
    padding: 14px 14px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap: 10px;
    -webkit-tap-highlight-color: transparent;
  }
  summary::-webkit-details-marker{ display:none; }
  .sumLeft{ min-width:0; display:flex; flex-direction:column; gap:4px;}
  .exName{
    font-weight: 950;
    font-size: 14px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .exMeta{
    font-size: 12px;
    color: var(--muted);
  }
  .sumRight{
    display:flex;
    align-items:center;
    gap: 8px;
    flex: 0 0 auto;
    font-family: var(--mono);
    color: var(--muted);
    font-size: 11px;
  }
  .chip{
    border: 1px solid rgba(229,231,235,.9);
    background: rgba(246,247,244,.8);
    padding: 6px 9px;
    border-radius: 999px;
    white-space:nowrap;
  }

  .exBody{
    padding: 12px 14px 14px;
    border-top: 1px solid rgba(229,231,235,.9);
    display:grid;
    gap: 10px;
  }

  /* Set rows */
  .setRow{
    display:grid;
    grid-template-columns: 64px 1fr 1fr 92px;
    gap: 8px;
    align-items:center;
  }
  .setLabel{
    font-family: var(--mono);
    font-weight: 900;
    color: var(--muted);
    font-size: 12px;
  }
  input[type="number"]{
    width: 100%;
    padding: 11px 10px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.95);
    outline:none;
    font-size: 14px;
  }
  input[type="number"]:focus{
    border-color: rgba(47,111,237,.45);
    box-shadow: 0 0 0 6px rgba(47,111,237,.12);
  }

  .btn{
    padding: 12px 12px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.95);
    font-weight: 900;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
    transition: transform .12s ease, background .18s ease;
  }
  .btn:active{ transform: scale(.99); }
  .btnPrimary{
    background: linear-gradient(180deg, rgba(47,111,237,.15), rgba(255,255,255,.96));
    border-color: rgba(47,111,237,.25);
    color: #0b1a3a;
  }
  .btnDanger{
    background: linear-gradient(180deg, rgba(239,68,68,.10), rgba(255,255,255,.96));
    border-color: rgba(239,68,68,.25);
    color: #3b0b0b;
  }

  .twoBtn{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .hint{
    border: 1px dashed rgba(229,231,235,.9);
    border-radius: 16px;
    background: rgba(246,247,244,.7);
    padding: 10px 10px;
    font-size: 12px;
    color: var(--muted);
    line-height: 1.35;
  }

  /* Timer panel (compact) */
  .timerDock{
    position: fixed;
    left: 12px;
    right: 12px;
    bottom: calc(70px + env(safe-area-inset-bottom));
    z-index: 25;
    max-width: 560px;
    margin: 0 auto;
    display:none;
  }
  .timerDock.show{ display:block; }
  .timerCard{
    border-radius: 20px;
    border: 1px solid rgba(47,111,237,.20);
    background: rgba(255,255,255,.92);
    box-shadow: 0 18px 40px rgba(15,23,42,.10);
    padding: 12px 12px;
    display:grid;
    gap: 10px;
  }
  .timerTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    min-width:0;
  }
  .timerTop .tTitle{
    min-width:0;
    display:flex;
    flex-direction:column;
    gap: 2px;
  }
  .timerTop b{
    font-size: 13px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .timerTop span{
    font-size: 12px;
    color: var(--muted);
  }
  .time{
    font-family: var(--mono);
    font-weight: 950;
    font-size: 28px;
    color: #0b1a3a;
  }
  .timerBtns{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
  }

  /* Metrics cards */
  .kpiGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .kpi{
    border: 1px solid rgba(229,231,235,.9);
    background: rgba(255,255,255,.88);
    border-radius: 18px;
    padding: 12px;
    box-shadow: 0 10px 22px rgba(15,23,42,.06);
  }
  .kpi .label{ font-size: 12px; color: var(--muted); font-weight: 800; margin-bottom: 6px; }
  .kpi .value{ font-family: var(--mono); font-size: 18px; font-weight: 950; }

  /* Table */
  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    border: 1px solid rgba(229,231,235,.9);
    border-radius: 16px;
    overflow:hidden;
    background: rgba(255,255,255,.92);
  }
  th, td{
    padding: 10px 10px;
    border-bottom: 1px solid rgba(229,231,235,.9);
    font-size: 12px;
  }
  th{
    text-align:left;
    color: var(--muted);
    background: rgba(246,247,244,.9);
    font-weight: 950;
  }
  tr:last-child td{ border-bottom:none; }

  /* Bottom nav */
  .nav{
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    height: 68px;
    padding-bottom: env(safe-area-inset-bottom);
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border-top: 1px solid rgba(229,231,235,.95);
    display:flex;
    z-index: 30;
  }
  .nav button{
    flex: 1 1 0;
    border: none;
    background: transparent;
    cursor:pointer;
    color: var(--muted);
    font-weight: 900;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap: 4px;
    font-size: 11px;
    -webkit-tap-highlight-color: transparent;
  }
  .nav button.active{
    color: var(--primary);
  }
  .nav .ico{
    font-size: 18px;
    line-height: 1;
  }

  /* Toast */
  .toast{
    position: fixed;
    left: 50%;
    top: calc(10px + env(safe-area-inset-top));
    transform: translateX(-50%);
    background: rgba(255,255,255,.95);
    border: 1px solid rgba(229,231,235,.95);
    padding: 10px 12px;
    border-radius: 999px;
    box-shadow: 0 14px 30px rgba(15,23,42,.10);
    opacity:0;
    pointer-events:none;
    transition: opacity .18s ease, transform .18s ease;
    font-size: 12px;
    z-index: 60;
  }
  .toast.show{
    opacity:1;
    transform: translateX(-50%) translateY(2px);
  }

  @media (max-width: 420px){
    .setRow{ grid-template-columns: 56px 1fr 1fr 86px; }
  }
</style>
</head>

<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbarInner">
    <div class="titleBlock">
      <div class="appTitle">üèãÔ∏è Treino Tracker</div>
      <div class="subPill">
        <span class="pill" id="todayPill">Carregando...</span>
        <span class="pill" id="workoutPill">‚Äî</span>
      </div>
    </div>

    <div class="topActions">
      <button class="iconBtn primary" id="btnExport" title="Exportar Treino CSV">‚¨áÔ∏è</button>
      <button class="iconBtn" id="btnBackup" title="Backup JSON">üßæ</button>
      <label class="iconBtn" title="Importar JSON" style="display:grid;place-items:center;cursor:pointer;">
        üì§
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </label>
      <button class="iconBtn danger" id="btnReset" title="Reset">üóëÔ∏è</button>
    </div>
  </div>
</div>

<div class="wrap">

  <!-- VIEW: TREINO -->
  <section id="viewTreino" class="view active">
    <div class="card">
      <div class="cardHead">
        <h2>üóìÔ∏è Treino</h2>
        <span class="pill" id="pillTitle">‚Äî</span>
      </div>
      <div class="cardBody">
        <div class="dayRow">
          <div style="width:100%">
            <div class="smallText" style="margin-bottom:8px;">Escolha o dia (ou deixe no autom√°tico de hoje)</div>
            <select id="daySelect" class="select"></select>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="smallText" id="dayDesc"></div>
        <div style="height:12px"></div>

        <div id="workoutList"></div>
      </div>
    </div>
  </section>

  <!-- VIEW: M√âTRICAS -->
  <section id="viewMetricas" class="view">
    <div class="card">
      <div class="cardHead">
        <h2>üìä M√©tricas</h2>
        <span class="pill">Resumo</span>
      </div>
      <div class="cardBody">
        <div class="kpiGrid">
          <div class="kpi">
            <div class="label">S√©ries hoje</div>
            <div class="value" id="kpiSetsToday">0</div>
          </div>
          <div class="kpi">
            <div class="label">Carga total hoje (kg)</div>
            <div class="value" id="kpiTonnageToday">0</div>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="kpi">
          <div class="label">√öltimo registro</div>
          <div class="value" id="kpiLastLog">Nenhum</div>
        </div>

        <div style="height:12px"></div>

        <div class="hint">
          <b>Dica</b><br>
          Para evoluir: quando bater o topo da faixa de reps com t√©cnica boa, aumente 2‚Äì5% na pr√≥xima sess√£o.
        </div>

        <div style="height:12px"></div>

        <button class="btn btnPrimary" id="btnExportFromMetrics" style="width:100%">Exportar CSV (treinos)</button>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <h2>üïò Hist√≥rico r√°pido</h2>
        <span class="pill">√∫ltimas 10</span>
      </div>
      <div class="cardBody">
        <div id="history"></div>
      </div>
    </div>
  </section>

  <!-- VIEW: PESO -->
  <section id="viewPeso" class="view">
    <div class="card">
      <div class="cardHead">
        <h2>‚öñÔ∏è Peso corporal</h2>
        <span class="pill" id="pesoHintPill">Sexta</span>
      </div>
      <div class="cardBody">
        <div class="smallText" id="pesoHintText">Registrar 1x por semana, toda sexta-feira.</div>
        <div style="height:10px"></div>

        <div class="twoBtn" style="grid-template-columns: 1fr;">
          <input id="weightInput" type="number" step="0.1" min="0" placeholder="Seu peso (kg) ex: 78.4" />
          <button class="btn btnPrimary" id="btnSaveWeight">Salvar peso</button>
        </div>

        <div style="height:10px"></div>
        <button class="btn" id="btnExportWeight" style="width:100%">Exportar CSV (peso)</button>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <h2>üìÖ Hist√≥rico de peso</h2>
        <span class="pill">√∫ltimos 12</span>
      </div>
      <div class="cardBody">
        <div id="weightHistory"></div>
      </div>
    </div>
  </section>

  <!-- VIEW: AJUSTES -->
  <section id="viewAjustes" class="view">
    <div class="card">
      <div class="cardHead">
        <h2>‚öôÔ∏è Ajustes</h2>
        <span class="pill">Dados</span>
      </div>
      <div class="cardBody">
        <div class="hint">
          Tudo fica salvo <b>no seu navegador</b>. Se trocar de celular, use <b>Backup</b> e depois <b>Importar</b>.
        </div>
        <div style="height:12px"></div>

        <button class="btn btnPrimary" id="btnBackup2" style="width:100%">Backup (JSON)</button>
        <div style="height:10px"></div>

        <label class="btn" style="width:100%;display:block;text-align:center;cursor:pointer;">
          Importar (JSON)
          <input id="importFile2" type="file" accept="application/json" style="display:none" />
        </label>

        <div style="height:10px"></div>
        <button class="btn btnDanger" id="btnReset2" style="width:100%">Reset (apagar tudo)</button>
      </div>
    </div>
  </section>

</div>

<!-- TIMER DOCK (aparece quando salva s√©rie) -->
<div class="timerDock" id="timerDock">
  <div class="timerCard">
    <div class="timerTop">
      <div class="tTitle">
        <b id="timerExercise">Descanso</b>
        <span id="timerHint">Quando voc√™ marcar uma s√©rie, o timer come√ßa.</span>
      </div>
      <div class="time" id="timerTime">00:00</div>
    </div>

    <div class="timerBtns">
      <button class="btn" id="btnStartStop">Iniciar</button>
      <button class="btn" id="btnPlus20">+20s</button>
      <button class="btn" id="btnResetTimer">Zerar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Salvo ‚úÖ</div>

<!-- Bottom Nav -->
<nav class="nav">
  <button class="active" data-view="viewTreino"><span class="ico">üèãÔ∏è</span>Treino</button>
  <button data-view="viewMetricas"><span class="ico">üìä</span>M√©tricas</button>
  <button data-view="viewPeso"><span class="ico">‚öñÔ∏è</span>Peso</button>
  <button data-view="viewAjustes"><span class="ico">‚öôÔ∏è</span>Ajustes</button>
</nav>

<script>
/* =========================
   1) PLANO DE TREINO (fixo)
   =========================
   Padr√µes usados:
   - Compostos: 3‚Äì4 s√©ries / reps moderadas / descanso 2‚Äì3 min
   - Isoladores: 2‚Äì3 s√©ries / reps 10‚Äì20 / descanso 60‚Äì90s
*/
const PLAN = {
  "Segunda": {
    title: "PUSH (Peito + Tr√≠ceps)",
    desc: "Foco em carga nos compostos e reps moderadas/altas nos isoladores. Ombro com eleva√ß√£o na m√°quina para completar.",
    exercises: [
      { name:"Supino inclinado", sets:4, repMin:6, repMax:8, restSec:180, note:"Composto pesado. T√©cnica e progress√£o." },
      { name:"Crucifixo na m√°quina", sets:3, repMin:10, repMax:12, restSec:75, note:"Controle e alongamento." },
      { name:"Paralelas", sets:3, repMin:8, repMax:12, restSec:120, note:"Quando bater 12 reps, aumenta carga." },
      { name:"Tr√≠ceps franc√™s", sets:3, repMin:8, repMax:10, restSec:90, note:"Amplitude, cotovelo est√°vel." },
      { name:"Extens√£o na polia (barra)", sets:3, repMin:12, repMax:15, restSec:75, note:"Finaliza√ß√£o, controle total." },
      { name:"Eleva√ß√£o na m√°quina (ombro)", sets:3, repMin:12, repMax:15, restSec:60, note:"Deltoide lateral gosta de reps." }
    ]
  },

  "Ter√ßa": {
    title: "PULL (Costas + B√≠ceps)",
    desc: "Costas com tens√£o mec√¢nica e boa execu√ß√£o. B√≠ceps com alongamento e controle.",
    exercises: [
      { name:"Puxada aberta na polia", sets:4, repMin:6, repMax:8, restSec:150, note:"Composto. Ombros longe das orelhas." },
      { name:"Pulldown com corda", sets:3, repMin:10, repMax:12, restSec:90, note:"Contra√ß√£o forte, sem roubo." },
      { name:"Remada aberta com halteres", sets:3, repMin:8, repMax:10, restSec:120, note:"Espessura. Tronco firme." },
      { name:"Rosca direta no banco inclinado", sets:3, repMin:8, repMax:10, restSec:90, note:"Alongamento m√°ximo." },
      { name:"Rosca Scott", sets:3, repMin:10, repMax:12, restSec:75, note:"Isolamento e controle." }
    ]
  },

  "Quarta": {
    title: "LEGS (Pernas completas)",
    desc: "Quadr√≠ceps com carga + volume. Posterior, abdutor e panturrilha com repeti√ß√µes mais altas e controle.",
    exercises: [
      { name:"Agachamento no Smith", sets:4, repMin:6, repMax:8, restSec:180, note:"Controle na descida, foco no quad." },
      { name:"Leg press 45¬∞", sets:3, repMin:10, repMax:12, restSec:120, note:"Amplitude segura. N√£o trave joelhos." },
      { name:"Cadeira extensora", sets:3, repMin:12, repMax:15, restSec:75, note:"Segura 1s no topo." },
      { name:"Cadeira flexora", sets:3, repMin:10, repMax:12, restSec:90, note:"Posterior com controle." },
      { name:"Cadeira abdutora", sets:3, repMin:15, repMax:20, restSec:60, note:"Reps altas, movimento limpo." },
      { name:"Panturrilha em p√© na m√°quina", sets:4, repMin:8, repMax:12, restSec:75, note:"Pausa 1s no pico, des√ßa completo." },
      { name:"Panturrilha sentada na m√°quina", sets:3, repMin:12, repMax:20, restSec:60, note:"Alta repeti√ß√£o e controle." }
    ]
  },

  "Quinta": {
    title: "UPPER BODY (Parte superior)",
    desc: "Volume moderado para peito/costas/ombros. √ìtimo para frequ√™ncia e recupera√ß√£o natural.",
    exercises: [
      { name:"Supino inclinado", sets:3, repMin:8, repMax:10, restSec:120, note:"Moderado. T√©cnica perfeita." },
      { name:"Crucifixo", sets:3, repMin:12, repMax:15, restSec:75, note:"Metab√≥lico e controle." },
      { name:"Flex√£o pegada fechada", sets:3, repMin:12, repMax:20, restSec:60, note:"Chega perto da falha na √∫ltima." },
      { name:"Puxada unilateral", sets:3, repMin:10, repMax:12, restSec:90, note:"Sinta o dorsal." },
      { name:"Remada baixa", sets:3, repMin:8, repMax:10, restSec:120, note:"Espessura e esc√°pula controlada." },
      { name:"Desenvolvimento", sets:3, repMin:6, repMax:8, restSec:150, note:"Carga com controle. Sem dor." },
      { name:"Eleva√ß√£o lateral na polia", sets:3, repMin:12, repMax:15, restSec:60, note:"Reps e controle." }
    ]
  },

  "Sexta": {
    title: "POSTERIOR + Complementos",
    desc: "Posterior com tens√£o e alongamento. Completa com extensora, adutora e panturrilhas.",
    exercises: [
      { name:"Stiff", sets:4, repMin:6, repMax:8, restSec:180, note:"T√©cnico. Coluna neutra." },
      { name:"Cadeira flexora", sets:3, repMin:10, repMax:12, restSec:90, note:"Controle total." },
      { name:"Mesa flexora", sets:3, repMin:8, repMax:10, restSec:90, note:"For√ßa e contra√ß√£o." },
      { name:"Cadeira extensora", sets:3, repMin:12, repMax:15, restSec:75, note:"Manuten√ß√£o do quad." },
      { name:"Cadeira adutora", sets:3, repMin:15, repMax:20, restSec:60, note:"Reps altas e controle." },
      { name:"Panturrilha em p√©", sets:4, repMin:8, repMax:12, restSec:75, note:"Pausa no topo." },
      { name:"Panturrilha sentada", sets:3, repMin:15, repMax:20, restSec:60, note:"Alta repeti√ß√£o." }
    ]
  },

  "S√°bado": { title:"OFF / Recupera√ß√£o", desc:"Caminhada leve + mobilidade. Cresce no descanso.", exercises:[] },
  "Domingo": { title:"OFF / Recupera√ß√£o", desc:"Se quiser, cardio leve 15‚Äì25 min.", exercises:[] }
};

const DAY_ORDER = ["Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo"];

/* =========================
   2) STORAGE
   ========================= */
const STORAGE_KEY = "treino_tracker_v2"; // nova vers√£o
const getState = () => {
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { logs: [], weights: [] };
    const obj = JSON.parse(raw);
    if(!obj.logs) obj.logs = [];
    if(!obj.weights) obj.weights = [];
    return obj;
  }catch(e){
    return { logs: [], weights: [] };
  }
};
const setState = (state) => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

/* logs item:
{
 id, dateISO, dayName, workoutTitle,
 exerciseName, setIndex, weight, reps,
 targetText, restSec, createdAt
}

weights item:
{
 id, dateISO, weightKg, createdAt
}
*/

/* =========================
   3) HELPERS
   ========================= */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

function pad2(n){ return String(n).padStart(2,"0"); }
function isoToday(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function formatDateBR(iso){
  const [y,m,d] = iso.split("-").map(Number);
  return `${pad2(d)}/${pad2(m)}/${y}`;
}
function dayNameFromDate(dateObj){
  const map = ["Domingo","Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado"];
  return map[dateObj.getDay()];
}
function fmtTime(sec){
  sec = Math.max(0, Math.floor(sec));
  const mm = String(Math.floor(sec/60)).padStart(2,"0");
  const ss = String(sec%60).padStart(2,"0");
  return `${mm}:${ss}`;
}
function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"), 1200);
}
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function safeCSV(v){
  const s = String(v ?? "");
  if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
  return s;
}

/* =========================
   4) NAV (views)
   ========================= */
function showView(viewId, btn){
  $$(".view").forEach(v => v.classList.remove("active"));
  $("#"+viewId).classList.add("active");
  $$(".nav button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");

  // render adicional por tela
  if(viewId === "viewMetricas"){ computeKPIs(); renderHistory(); }
  if(viewId === "viewPeso"){ renderWeightUI(); }
}
$$(".nav button").forEach(btn=>{
  btn.addEventListener("click", ()=> showView(btn.dataset.view, btn));
});

/* =========================
   5) TIMER
   ========================= */
let timer = { running:false, remaining:0, interval:null, exercise:"", defaultRest:0 };

function timerRender(){
  $("#timerExercise").textContent = timer.exercise ? `Descanso: ${timer.exercise}` : "Descanso";
  $("#timerTime").textContent = fmtTime(timer.remaining);
  $("#btnStartStop").textContent = timer.running ? "Pausar" : "Iniciar";
  $("#timerHint").textContent = timer.exercise
    ? `Sugest√£o: ${Math.round(timer.defaultRest/60)} min. (+20s se precisar)`
    : "Quando voc√™ marcar uma s√©rie, o timer aparece aqui.";
  $("#timerDock").classList.toggle("show", !!timer.exercise);
}
function timerStart(){
  if(timer.running) return;
  timer.running = true;
  timer.interval = setInterval(()=>{
    timer.remaining -= 1;
    if(timer.remaining <= 0){
      timer.remaining = 0;
      timerStop();
      toast("Descanso finalizado üîî");
    }
    timerRender();
  }, 1000);
  timerRender();
}
function timerStop(){
  timer.running = false;
  if(timer.interval) clearInterval(timer.interval);
  timer.interval = null;
  timerRender();
}
function timerReset(toSec=null){
  timerStop();
  timer.remaining = (toSec !== null) ? toSec : (timer.defaultRest || 0);
  timerRender();
}
function timerAdd(sec){
  timer.remaining += sec;
  timerRender();
}

$("#btnStartStop").addEventListener("click", ()=> timer.running ? timerStop() : timerStart());
$("#btnPlus20").addEventListener("click", ()=> timerAdd(20));
$("#btnResetTimer").addEventListener("click", ()=> {
  timer.exercise = "";
  timer.defaultRest = 0;
  timerReset(0);
});

/* =========================
   6) TREINO UI
   ========================= */
let selectedDay = null;

function populateDaySelect(todayName){
  const sel = $("#daySelect");
  sel.innerHTML = "";
  DAY_ORDER.forEach(d=>{
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d;
    sel.appendChild(opt);
  });
  sel.value = selectedDay || todayName;
}

function getLogsFor(dateISO, dayName, exName){
  const st = getState();
  return st.logs.filter(l =>
    l.dateISO === dateISO &&
    l.dayName === dayName &&
    l.exerciseName === exName
  ).sort((a,b)=> a.setIndex - b.setIndex);
}

function latestForExercise(exName){
  const st = getState();
  const logs = st.logs.filter(l => l.exerciseName === exName)
    .sort((a,b)=> b.createdAt - a.createdAt);
  return logs[0] || null;
}

function renderWorkout(){
  const todayISO = isoToday();
  const plan = PLAN[selectedDay];

  $("#pillTitle").textContent = plan.title;
  $("#workoutPill").textContent = plan.title;
  $("#dayDesc").textContent = plan.desc;

  const container = $("#workoutList");
  container.innerHTML = "";

  if(!plan.exercises.length){
    container.innerHTML = `
      <div class="hint">
        <b>${plan.title}</b><br>
        ${plan.desc}
      </div>
    `;
    return;
  }

  plan.exercises.forEach(ex=>{
    const details = document.createElement("details");
    details.className = "exercise";

    const last = latestForExercise(ex.name);
    const lastStr = last ? `${last.weight}kg x ${last.reps} (${formatDateBR(last.dateISO)})` : "sem hist√≥rico";
    const doneLogs = getLogsFor(todayISO, selectedDay, ex.name);
    const doneCount = doneLogs.length;

    const summary = document.createElement("summary");
    summary.innerHTML = `
      <div class="sumLeft">
        <div class="exName">${ex.name}</div>
        <div class="exMeta">Alvo: <b>${ex.sets}x ${ex.repMin}‚Äì${ex.repMax}</b> ‚Ä¢ Descanso: <b>${Math.round(ex.restSec/60)} min</b></div>
      </div>
      <div class="sumRight">
        <span class="chip">${doneCount}/${ex.sets}</span>
        <span class="chip">${lastStr}</span>
      </div>
    `;
    details.appendChild(summary);

    const body = document.createElement("div");
    body.className = "exBody";

    // set inputs
    for(let i=1;i<=ex.sets;i++){
      const prev = doneLogs.find(l => l.setIndex === i) || null;

      const row = document.createElement("div");
      row.className = "setRow";
      row.innerHTML = `
        <div class="setLabel">#${i}</div>
        <div>
          <input type="number" step="0.5" min="0" inputmode="decimal" placeholder="Peso (kg)"
                 data-field="weight" data-set="${i}" value="${prev ? prev.weight : ""}">
        </div>
        <div>
          <input type="number" step="1" min="0" inputmode="numeric" placeholder="Reps"
                 data-field="reps" data-set="${i}" value="${prev ? prev.reps : ""}">
        </div>
        <div style="text-align:right">
          <button class="btn ${prev ? "btnPrimary" : ""}" data-action="done" data-set="${i}">
            ${prev ? "Feito ‚úÖ" : "Marcar"}
          </button>
        </div>
      `;
      body.appendChild(row);
    }

    const hint = document.createElement("div");
    hint.className = "hint";
    hint.innerHTML = `
      <b>Objetivo</b><br>
      ${ex.note}<br>
      <span class="smallText">Natural: falha s√≥ na √∫ltima s√©rie. Antes disso, pare com 1‚Äì2 reps na reserva.</span>
    `;

    const actions = document.createElement("div");
    actions.className = "twoBtn";
    actions.innerHTML = `
      <button class="btn" data-action="copyLast">Usar √∫ltimo peso/reps</button>
      <button class="btn btnDanger" data-action="clearToday">Limpar hoje</button>
    `;

    body.appendChild(hint);
    body.appendChild(actions);

    body.addEventListener("click", (ev)=>{
      const btn = ev.target.closest("button");
      if(!btn) return;
      const action = btn.dataset.action;

      if(action === "done"){
        const setIndex = Number(btn.dataset.set);
        onMarkSetDone(ex, setIndex, body);
      }
      if(action === "copyLast") onCopyLast(ex, body);
      if(action === "clearToday") onClearToday(ex);
    });

    details.appendChild(body);
    container.appendChild(details);
  });
}

function readInputsForSet(body, setIndex){
  const w = body.querySelector(`input[data-field="weight"][data-set="${setIndex}"]`);
  const r = body.querySelector(`input[data-field="reps"][data-set="${setIndex}"]`);
  const weight = w ? Number(w.value) : NaN;
  const reps = r ? Number(r.value) : NaN;
  return { weight, reps };
}

function onMarkSetDone(ex, setIndex, body){
  const { weight, reps } = readInputsForSet(body, setIndex);

  if(!Number.isFinite(weight) || weight <= 0){ toast("Coloque o peso ‚úÖ"); return; }
  if(!Number.isFinite(reps) || reps <= 0){ toast("Coloque as reps ‚úÖ"); return; }

  const st = getState();
  const todayISO = isoToday();

  st.logs = st.logs.filter(l => !(l.dateISO === todayISO && l.dayName === selectedDay && l.exerciseName === ex.name && l.setIndex === setIndex));

  st.logs.push({
    id: uid(),
    dateISO: todayISO,
    dayName: selectedDay,
    workoutTitle: PLAN[selectedDay].title,
    exerciseName: ex.name,
    setIndex,
    weight,
    reps,
    targetText: `${ex.sets}x ${ex.repMin}‚Äì${ex.repMax}`,
    restSec: ex.restSec,
    createdAt: Date.now()
  });

  setState(st);
  toast("S√©rie salva ‚úÖ");

  // timer
  timer.exercise = ex.name;
  timer.defaultRest = ex.restSec;
  timerReset(ex.restSec);
  timerStart();

  // re-render
  renderWorkout();
  computeKPIs(); // atualiza tamb√©m
}

function onCopyLast(ex, body){
  const last = latestForExercise(ex.name);
  if(!last){ toast("Sem hist√≥rico"); return; }
  for(let i=1;i<=ex.sets;i++){
    const w = body.querySelector(`input[data-field="weight"][data-set="${i}"]`);
    const r = body.querySelector(`input[data-field="reps"][data-set="${i}"]`);
    if(w && !w.value) w.value = last.weight;
    if(r && !r.value) r.value = last.reps;
  }
  toast("Preenchido ‚úÖ");
}

function onClearToday(ex){
  const st = getState();
  const todayISO = isoToday();
  const before = st.logs.length;
  st.logs = st.logs.filter(l => !(l.dateISO === todayISO && l.dayName === selectedDay && l.exerciseName === ex.name));
  setState(st);
  toast(before !== st.logs.length ? "Hoje limpo" : "Nada p/ apagar");
  renderWorkout();
  computeKPIs();
}

/* =========================
   7) M√âTRICAS
   ========================= */
function computeKPIs(){
  const st = getState();
  const todayISO = isoToday();
  const todayLogs = st.logs.filter(l => l.dateISO === todayISO);

  const setsToday = todayLogs.length;
  let tonnage = 0;
  todayLogs.forEach(l => tonnage += (Number(l.weight)||0) * (Number(l.reps)||0));

  const last = st.logs.slice().sort((a,b)=> b.createdAt - a.createdAt)[0] || null;

  $("#kpiSetsToday").textContent = setsToday.toString();
  $("#kpiTonnageToday").textContent = Math.round(tonnage).toString();
  $("#kpiLastLog").textContent = last ? `${last.exerciseName} (${last.weight}kg x ${last.reps})` : "Nenhum";
}

function renderHistory(){
  const st = getState();
  const logs = st.logs.slice().sort((a,b)=> b.createdAt - a.createdAt).slice(0, 10);
  const el = $("#history");

  if(!logs.length){
    el.innerHTML = `<div class="hint">Sem registros ainda. Marque uma s√©rie como feita no Treino.</div>`;
    return;
  }

  const rows = logs.map(l => `
    <tr>
      <td>${formatDateBR(l.dateISO)}</td>
      <td>${l.dayName}</td>
      <td>${l.exerciseName}</td>
      <td style="font-family:var(--mono);font-weight:900">#${l.setIndex}</td>
      <td>${l.weight}</td>
      <td>${l.reps}</td>
    </tr>
  `).join("");

  el.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Data</th><th>Dia</th><th>Exerc√≠cio</th><th>S√©rie</th><th>Peso</th><th>Reps</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

/* =========================
   8) PESO SEMANAL
   ========================= */
function isFriday(dateObj){
  // JS: 5 = Friday
  return dateObj.getDay() === 5;
}

function renderWeightUI(){
  const today = new Date();
  const friday = isFriday(today);
  $("#pesoHintPill").textContent = friday ? "Hoje √© sexta ‚úÖ" : "Sexta";
  $("#pesoHintText").textContent = friday
    ? "Boa! Registre seu peso semanal hoje."
    : "Registrar 1x por semana, toda sexta-feira (mas voc√™ pode registrar quando quiser).";

  renderWeightHistory();
}

function renderWeightHistory(){
  const st = getState();
  const logs = st.weights.slice().sort((a,b)=> b.createdAt - a.createdAt).slice(0, 12);
  const el = $("#weightHistory");

  if(!logs.length){
    el.innerHTML = `<div class="hint">Sem registros de peso ainda.</div>`;
    return;
  }

  const rows = logs.map(w => `
    <tr>
      <td>${formatDateBR(w.dateISO)}</td>
      <td style="font-family:var(--mono);font-weight:950">${w.weightKg}</td>
    </tr>
  `).join("");

  el.innerHTML = `
    <table>
      <thead><tr><th>Data</th><th>Peso (kg)</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

$("#btnSaveWeight").addEventListener("click", ()=>{
  const value = Number($("#weightInput").value);
  if(!Number.isFinite(value) || value <= 0){
    toast("Digite um peso v√°lido ‚úÖ");
    return;
  }
  const st = getState();
  const todayISO = isoToday();

  // Permite 1 registro por dia (se salvar de novo no mesmo dia, sobrescreve)
  st.weights = st.weights.filter(w => w.dateISO !== todayISO);
  st.weights.push({
    id: uid(),
    dateISO: todayISO,
    weightKg: Number(value.toFixed(1)),
    createdAt: Date.now()
  });

  setState(st);
  $("#weightInput").value = "";
  toast("Peso salvo ‚úÖ");
  renderWeightHistory();
});

function exportWeightCSV(){
  const st = getState();
  const items = st.weights.slice().sort((a,b)=> a.createdAt - b.createdAt);
  if(!items.length){ toast("Sem peso p/ exportar"); return; }

  const header = ["data","peso_kg"];
  const lines = [header.join(",")];
  items.forEach(w=>{
    lines.push([w.dateISO, w.weightKg].join(","));
  });

  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `peso_${isoToday()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("CSV (peso) ‚úÖ");
}
$("#btnExportWeight").addEventListener("click", exportWeightCSV);

/* =========================
   9) EXPORT / BACKUP / IMPORT / RESET
   ========================= */
function exportWorkoutCSV(){
  const st = getState();
  const logs = st.logs.slice().sort((a,b)=> a.createdAt - b.createdAt);
  if(!logs.length){ toast("Nada p/ exportar"); return; }

  const header = ["data","dia","treino","exercicio","serie","peso_kg","reps","alvo","descanso_seg"];
  const lines = [header.join(",")];

  logs.forEach(l=>{
    lines.push([
      l.dateISO,
      safeCSV(l.dayName),
      safeCSV(l.workoutTitle),
      safeCSV(l.exerciseName),
      l.setIndex,
      l.weight,
      l.reps,
      safeCSV(l.targetText),
      l.restSec
    ].join(","));
  });

  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `treino_logs_${isoToday()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("CSV (treino) ‚úÖ");
}

$("#btnExport").addEventListener("click", exportWorkoutCSV);
$("#btnExportFromMetrics").addEventListener("click", exportWorkoutCSV);

function backupJSON(){
  const st = getState();
  const blob = new Blob([JSON.stringify(st, null, 2)], { type: "application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `backup_treino_${isoToday()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("Backup ‚úÖ");
}
$("#btnBackup").addEventListener("click", backupJSON);
$("#btnBackup2").addEventListener("click", backupJSON);

function importJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);
      if(!obj || (!Array.isArray(obj.logs) && !Array.isArray(obj.weights))) throw new Error("Formato inv√°lido");

      const merged = {
        logs: Array.isArray(obj.logs) ? obj.logs : [],
        weights: Array.isArray(obj.weights) ? obj.weights : []
      };

      setState(merged);
      toast("Importado ‚úÖ");
      renderAll();
    }catch(e){
      toast("Falha ‚ùå");
      alert("Arquivo inv√°lido. Use um backup gerado pelo pr√≥prio site.");
    }
  };
  reader.readAsText(file);
}

$("#importFile").addEventListener("change", (ev)=>{
  const file = ev.target.files?.[0];
  if(file) importJSON(file);
  ev.target.value = "";
});
$("#importFile2").addEventListener("change", (ev)=>{
  const file = ev.target.files?.[0];
  if(file) importJSON(file);
  ev.target.value = "";
});

function resetAll(){
  if(!confirm("Apagar tudo? Isso remove registros do navegador.")) return;
  localStorage.removeItem(STORAGE_KEY);
  timer.exercise = "";
  timer.defaultRest = 0;
  timerReset(0);
  toast("Reset ‚úÖ");
  renderAll();
}
$("#btnReset").addEventListener("click", resetAll);
$("#btnReset2").addEventListener("click", resetAll);

/* =========================
   10) INIT
   ========================= */
function renderAll(){
  const today = new Date();
  const todayName = dayNameFromDate(today);
  const todayISO = isoToday();

  if(!selectedDay) selectedDay = todayName;

  $("#todayPill").textContent = `${todayName} ‚Ä¢ ${formatDateBR(todayISO)}`;
  populateDaySelect(todayName);

  renderWorkout();
  computeKPIs();
  renderHistory();
  renderWeightUI();
  timerRender();
}

$("#daySelect").addEventListener("change", ()=>{
  selectedDay = $("#daySelect").value;
  renderWorkout();
  $("#workoutPill").textContent = PLAN[selectedDay].title;
});

renderAll();
</script>
</body>
</html>
