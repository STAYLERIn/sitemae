<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="theme-color" content="#f6f7fb" />
<title>Treino Tracker ‚Ä¢ Modern</title>

<style>
  :root{
    /* Light palette (clean + premium) */
    --bg: #f6f7fb;
    --surface: rgba(255,255,255,.72);
    --card: rgba(255,255,255,.86);
    --text: #0f172a;
    --muted: #64748b;
    --border: rgba(148,163,184,.26);

    --primary: #2563eb;
    --primary2: #7c3aed;
    --good: #16a34a;
    --warn: #f59e0b;
    --danger: #ef4444;

    --radius: 20px;
    --radius2: 16px;
    --shadow: 0 16px 40px rgba(15,23,42,.08);
    --shadow2: 0 10px 26px rgba(15,23,42,.08);
    --ring: 0 0 0 6px rgba(37,99,235,.14);

    --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: var(--font);
    color: var(--text);
    background:
      radial-gradient(900px 520px at 12% -10%, rgba(37,99,235,.14), transparent 58%),
      radial-gradient(900px 520px at 88% -10%, rgba(124,58,237,.12), transparent 58%),
      radial-gradient(900px 520px at 50% 120%, rgba(16,185,129,.10), transparent 58%),
      var(--bg);
    padding-bottom: calc(92px + env(safe-area-inset-bottom));
    -webkit-font-smoothing: antialiased;
  }

  /* Topbar */
  .topbar{
    position: sticky;
    top:0;
    z-index: 50;
    padding-top: env(safe-area-inset-top);
    background: rgba(246,247,251,.72);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
  }
  .topbarInner{
    max-width: 980px;
    margin: 0 auto;
    padding: 14px 14px 12px;
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 12px;
  }
  .brand{
    display:flex;
    align-items:center;
    gap: 10px;
    min-width:0;
  }
  .logo{
    width:42px;height:42px;border-radius:16px;
    display:grid;place-items:center;
    background: linear-gradient(145deg, rgba(37,99,235,.20), rgba(124,58,237,.14));
    border: 1px solid rgba(37,99,235,.18);
    box-shadow: var(--shadow2);
    flex: 0 0 auto;
  }
  .titleBlock{min-width:0}
  .appTitle{
    margin:0;
    font-size: 14px;
    font-weight: 950;
    letter-spacing:.2px;
    line-height:1.1;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .subline{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top: 6px;
  }
  .pill{
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    border: 1px solid var(--border);
    background: rgba(255,255,255,.68);
    padding: 6px 10px;
    border-radius: 999px;
    white-space:nowrap;
  }

  .actions{
    display:flex;
    gap:10px;
    align-items:center;
  }
  .iconBtn{
    width: 42px; height: 42px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.76);
    box-shadow: var(--shadow2);
    display:grid;
    place-items:center;
    cursor:pointer;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
    transition: transform .12s ease, filter .18s ease, background .18s ease;
  }
  .iconBtn:hover{ filter: brightness(1.02); }
  .iconBtn:active{ transform: scale(.98); }
  .iconBtn.primary{
    border-color: rgba(37,99,235,.22);
    background: linear-gradient(180deg, rgba(37,99,235,.16), rgba(255,255,255,.76));
  }
  .iconBtn.danger{
    border-color: rgba(239,68,68,.22);
    background: linear-gradient(180deg, rgba(239,68,68,.10), rgba(255,255,255,.76));
  }

  /* Layout */
  .wrap{
    max-width: 980px;
    margin: 0 auto;
    padding: 14px;
    display:grid;
    grid-template-columns: 1.25fr .75fr;
    gap: 14px;
  }
  @media (max-width: 920px){
    .wrap{ grid-template-columns: 1fr; }
  }

  .view{ display:none; }
  .view.active{ display:block; }

  .card{
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--card);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card + .card{ margin-top: 14px; }

  .cardHead{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 10px;
    padding: 14px 14px 12px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(255,255,255,.72), rgba(255,255,255,.20));
  }
  .cardHead h2{
    margin:0;
    font-size: 13px;
    font-weight: 950;
    letter-spacing:.2px;
    display:flex;
    align-items:center;
    gap: 8px;
  }
  .cardBody{ padding: 14px; }

  .small{ font-size: 12px; color: var(--muted); line-height: 1.35; }
  .muted{ color: var(--muted); }

  /* Controls */
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .control{
    width: 100%;
    padding: 12px 12px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.72);
    outline:none;
    color: var(--text);
    font-weight: 800;
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  .control:focus{ border-color: rgba(37,99,235,.45); box-shadow: var(--ring); }
  .segmented{
    display:flex;
    gap: 8px;
    background: rgba(255,255,255,.42);
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 6px;
  }
  .segmented button{
    border:none;
    border-radius: 999px;
    padding: 10px 12px;
    background: transparent;
    cursor:pointer;
    font-weight: 950;
    color: var(--muted);
    -webkit-tap-highlight-color: transparent;
    transition: background .15s ease, color .15s ease;
  }
  .segmented button.active{
    color: #0b1a3a;
    background: rgba(37,99,235,.16);
    border: 1px solid rgba(37,99,235,.18);
  }

  .btn{
    padding: 12px 12px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.74);
    font-weight: 950;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
    transition: transform .12s ease, filter .18s ease, background .18s ease;
  }
  .btn:hover{ filter: brightness(1.02); }
  .btn:active{ transform: scale(.99); }
  .btnPrimary{
    border-color: rgba(37,99,235,.22);
    background: linear-gradient(180deg, rgba(37,99,235,.16), rgba(255,255,255,.76));
  }
  .btnDanger{
    border-color: rgba(239,68,68,.22);
    background: linear-gradient(180deg, rgba(239,68,68,.10), rgba(255,255,255,.76));
    color: #3b0b0b;
  }
  .btnGhost{
    background: rgba(255,255,255,.36);
  }

  .hint{
    border: 1px dashed rgba(148,163,184,.45);
    border-radius: 18px;
    background: rgba(255,255,255,.46);
    padding: 10px 10px;
    font-size: 12px;
    color: var(--muted);
    line-height: 1.35;
  }

  /* Exercise cards */
  details.exercise{
    border: 1px solid var(--border);
    border-radius: var(--radius2);
    background: rgba(255,255,255,.72);
    overflow:hidden;
    margin-bottom: 10px;
  }
  details.exercise[open]{
    border-color: rgba(37,99,235,.22);
    box-shadow: 0 14px 26px rgba(37,99,235,.10);
  }
  summary{
    list-style:none;
    cursor:pointer;
    padding: 14px 14px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    -webkit-tap-highlight-color: transparent;
  }
  summary::-webkit-details-marker{ display:none; }

  .sumLeft{ min-width:0; display:flex; flex-direction:column; gap:4px; }
  .exName{
    font-weight: 950;
    font-size: 14px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .exMeta{ font-size: 12px; color: var(--muted); }
  .sumRight{
    display:flex; align-items:center; gap:8px;
    font-family: var(--mono); color: var(--muted); font-size: 11px;
    flex: 0 0 auto;
  }
  .chip{
    border: 1px solid var(--border);
    background: rgba(246,247,251,.66);
    padding: 6px 10px;
    border-radius: 999px;
    white-space:nowrap;
  }
  .chip.ok{ border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.10); color:#064e3b; }
  .chip.warn{ border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.10); color:#6b3b00; }

  .exBody{
    padding: 12px 14px 14px;
    border-top: 1px solid var(--border);
    display:grid;
    gap:10px;
  }

  /* Sets */
  .setRow{
    display:grid;
    grid-template-columns: 60px 1fr 1fr 110px;
    gap: 8px;
    align-items:center;
  }
  .setLabel{
    font-family: var(--mono);
    font-weight: 950;
    color: var(--muted);
    font-size: 12px;
  }
  input[type="number"]{
    width:100%;
    padding: 11px 10px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.76);
    outline:none;
    font-size: 14px;
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  input[type="number"]:focus{ border-color: rgba(37,99,235,.45); box-shadow: var(--ring); }

  .twoBtn{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  @media (max-width: 420px){
    .setRow{ grid-template-columns: 54px 1fr 1fr 100px; }
  }

  /* Side panel */
  .sideStack .card{ position: sticky; top: 86px; }
  @media (max-width: 920px){
    .sideStack .card{ position: static; }
  }

  .kpiGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .kpi{
    border: 1px solid var(--border);
    background: rgba(255,255,255,.70);
    border-radius: 18px;
    padding: 12px;
    box-shadow: var(--shadow2);
  }
  .kpi .label{ font-size: 12px; color: var(--muted); font-weight: 900; margin-bottom: 6px;}
  .kpi .value{ font-family: var(--mono); font-weight: 950; font-size: 18px; }

  /* Table */
  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow:hidden;
    background: rgba(255,255,255,.74);
  }
  th,td{
    padding: 10px 10px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
  }
  th{
    text-align:left;
    color: var(--muted);
    background: rgba(246,247,251,.74);
    font-weight: 950;
  }
  tr:last-child td{ border-bottom:none; }

  /* Bottom nav */
  .nav{
    position: fixed;
    left:0; right:0; bottom:0;
    height: 72px;
    padding-bottom: env(safe-area-inset-bottom);
    background: rgba(255,255,255,.74);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-top: 1px solid var(--border);
    display:flex;
    z-index: 60;
  }
  .nav button{
    flex:1 1 0;
    border:none;
    background:transparent;
    cursor:pointer;
    color: var(--muted);
    font-weight: 950;
    display:flex;
    flex-direction:column;
    gap: 5px;
    align-items:center;
    justify-content:center;
    font-size: 11px;
    -webkit-tap-highlight-color: transparent;
    transition: color .15s ease;
  }
  .nav button.active{ color: var(--primary); }
  .nav .ico{ font-size: 18px; line-height:1; }

  /* Timer dock */
  .timerDock{
    position: fixed;
    left: 12px; right: 12px;
    bottom: calc(78px + env(safe-area-inset-bottom));
    z-index: 70;
    max-width: 980px;
    margin:0 auto;
    display:none;
  }
  .timerDock.show{ display:block; }
  .timerCard{
    border-radius: 22px;
    border: 1px solid rgba(37,99,235,.20);
    background: rgba(255,255,255,.84);
    box-shadow: 0 18px 44px rgba(15,23,42,.14);
    padding: 12px;
    display:grid;
    gap: 10px;
  }
  .timerTop{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    min-width:0;
  }
  .timerTop .tTitle{ min-width:0; display:flex; flex-direction:column; gap:2px; }
  .timerTop b{
    font-size: 13px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .timerTop span{ font-size: 12px; color: var(--muted); }
  .time{
    font-family: var(--mono);
    font-weight: 950;
    font-size: 28px;
    color: #0b1a3a;
  }
  .timerBtns{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr 1fr;
    gap: 10px;
  }

  /* Toast */
  .toast{
    position: fixed;
    left: 50%;
    top: calc(10px + env(safe-area-inset-top));
    transform: translateX(-50%);
    background: rgba(255,255,255,.86);
    border: 1px solid var(--border);
    padding: 10px 12px;
    border-radius: 999px;
    box-shadow: 0 18px 40px rgba(15,23,42,.12);
    opacity:0;
    pointer-events:none;
    transition: opacity .18s ease, transform .18s ease;
    font-size: 12px;
    z-index: 80;
  }
  .toast.show{ opacity:1; transform: translateX(-50%) translateY(2px); }

  /* Tiny badges */
  .badge{
    font-family: var(--mono);
    font-size: 11px;
    border-radius: 999px;
    padding: 6px 10px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.60);
    color: var(--muted);
    display:inline-flex;
    align-items:center;
    gap:6px;
    white-space:nowrap;
  }
</style>
</head>

<body>

<!-- TOPBAR -->
<header class="topbar">
  <div class="topbarInner">
    <div class="brand">
      <div class="logo" title="Treino Tracker">üèãÔ∏è</div>
      <div class="titleBlock">
        <div class="appTitle">Treino Tracker</div>
        <div class="subline">
          <span class="pill" id="todayPill">Carregando...</span>
          <span class="pill" id="workoutPill">‚Äî</span>
          <span class="pill" id="streakPill">üî• 0 dias</span>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="iconBtn primary" id="btnExport" title="Exportar CSV">‚¨áÔ∏è</button>
      <button class="iconBtn" id="btnBackup" title="Backup JSON">üßæ</button>

      <label class="iconBtn" title="Importar JSON" style="display:grid;place-items:center;cursor:pointer;">
        üì§
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </label>

      <button class="iconBtn danger" id="btnReset" title="Reset">üóëÔ∏è</button>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: VIEWS -->
  <main>
    <!-- VIEW: TREINO -->
    <section id="viewTreino" class="view active">
      <div class="card">
        <div class="cardHead">
          <h2>üóìÔ∏è Treino</h2>
          <span class="pill" id="pillTitle">‚Äî</span>
        </div>

        <div class="cardBody">
          <div class="row">
            <div style="flex:1 1 320px; min-width:240px">
              <div class="small" style="margin-bottom:8px;">Dia do plano</div>
              <select id="daySelect" class="control"></select>
            </div>

            <div style="flex:1 1 320px; min-width:240px">
              <div class="small" style="margin-bottom:8px;">Buscar exerc√≠cio</div>
              <input id="searchInput" class="control" placeholder="Ex: supino, puxada, panturrilha..." />
            </div>

            <div style="flex: 0 0 auto">
              <div class="small" style="margin-bottom:8px;">Filtro</div>
              <div class="segmented" id="segFilter">
                <button data-filter="all" class="active" title="Mostrar tudo">Tudo</button>
                <button data-filter="pending" title="Somente pendentes">Pend.</button>
                <button data-filter="done" title="Somente feitos">Feitos</button>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>
          <div class="small" id="dayDesc"></div>

          <div style="height:12px"></div>
          <div id="workoutList"></div>
        </div>
      </div>
    </section>

    <!-- VIEW: M√âTRICAS -->
    <section id="viewMetricas" class="view">
      <div class="card">
        <div class="cardHead">
          <h2>üìä M√©tricas</h2>
          <span class="pill">Resumo</span>
        </div>
        <div class="cardBody">
          <div class="kpiGrid">
            <div class="kpi">
              <div class="label">S√©ries hoje</div>
              <div class="value" id="kpiSetsToday">0</div>
            </div>
            <div class="kpi">
              <div class="label">Carga total hoje (kg)</div>
              <div class="value" id="kpiTonnageToday">0</div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="kpi">
            <div class="label">√öltimo registro</div>
            <div class="value" id="kpiLastLog">Nenhum</div>
          </div>

          <div style="height:12px"></div>

          <div class="hint" id="progressHint">
            <b>Progress√£o inteligente</b><br>
            Quando voc√™ bater o topo da faixa de reps com boa t√©cnica, suba 2‚Äì5% na pr√≥xima sess√£o.
          </div>

          <div style="height:12px"></div>
          <button class="btn btnPrimary" id="btnExportFromMetrics" style="width:100%">Exportar CSV (treinos)</button>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <h2>üïò Hist√≥rico</h2>
          <span class="pill">√∫ltimas 12</span>
        </div>
        <div class="cardBody">
          <div id="history"></div>
        </div>
      </div>
    </section>

    <!-- VIEW: PESO -->
    <section id="viewPeso" class="view">
      <div class="card">
        <div class="cardHead">
          <h2>‚öñÔ∏è Peso</h2>
          <span class="pill" id="pesoHintPill">Sexta</span>
        </div>
        <div class="cardBody">
          <div class="small" id="pesoHintText">Registrar 1x por semana, toda sexta-feira.</div>
          <div style="height:10px"></div>

          <div class="row" style="gap:10px">
            <input id="weightInput" class="control" type="number" step="0.1" min="0" placeholder="Seu peso (kg) ex: 78.4" style="flex:1 1 240px" />
            <button class="btn btnPrimary" id="btnSaveWeight" style="flex:0 0 auto">Salvar</button>
          </div>

          <div style="height:10px"></div>
          <button class="btn" id="btnExportWeight" style="width:100%">Exportar CSV (peso)</button>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <h2>üìÖ Hist√≥rico de peso</h2>
          <span class="pill">√∫ltimos 12</span>
        </div>
        <div class="cardBody">
          <div id="weightHistory"></div>
        </div>
      </div>
    </section>

    <!-- VIEW: AJUSTES -->
    <section id="viewAjustes" class="view">
      <div class="card">
        <div class="cardHead">
          <h2>‚öôÔ∏è Ajustes</h2>
          <span class="pill">Dados</span>
        </div>
        <div class="cardBody">
          <div class="hint">
            Tudo fica salvo <b>no seu navegador</b>. Se trocar de celular, fa√ßa <b>Backup</b> e depois <b>Importar</b>.
          </div>

          <div style="height:12px"></div>

          <button class="btn btnPrimary" id="btnBackup2" style="width:100%">Backup (JSON)</button>
          <div style="height:10px"></div>

          <label class="btn btnGhost" style="width:100%;display:block;text-align:center;cursor:pointer;">
            Importar (JSON)
            <input id="importFile2" type="file" accept="application/json" style="display:none" />
          </label>

          <div style="height:10px"></div>
          <button class="btn btnDanger" id="btnReset2" style="width:100%">Reset (apagar tudo)</button>

          <div style="height:12px"></div>
          <div class="small">
            Atalhos (desktop): <span class="badge">/ buscar</span> <span class="badge">T ir para Treino</span>
            <span class="badge">M M√©tricas</span> <span class="badge">P Peso</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- RIGHT: SIDE PANEL -->
  <aside class="sideStack">
    <div class="card">
      <div class="cardHead">
        <h2>‚ú® Hoje</h2>
        <span class="pill" id="todaySummaryPill">‚Äî</span>
      </div>
      <div class="cardBody">
        <div class="kpiGrid">
          <div class="kpi">
            <div class="label">Feitas / Planejadas</div>
            <div class="value" id="kpiProgress">0/0</div>
          </div>
          <div class="kpi">
            <div class="label">Tempo de descanso</div>
            <div class="value" id="kpiRest">‚Äî</div>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="hint" id="sideTip">
          <b>Dica r√°pida</b><br>
          Marque uma s√©rie e o timer aparece. Se a t√©cnica cair, mantenha reps e refine a execu√ß√£o.
        </div>

        <div style="height:12px"></div>
        <div class="row">
          <button class="btn btnPrimary" id="btnQuickExport" style="flex:1">Exportar</button>
          <button class="btn" id="btnJumpToday" style="flex:1">Ir p/ hoje</button>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- TIMER DOCK -->
<div class="timerDock" id="timerDock">
  <div class="timerCard">
    <div class="timerTop">
      <div class="tTitle">
        <b id="timerExercise">Descanso</b>
        <span id="timerHint">Quando voc√™ marcar uma s√©rie, o timer come√ßa.</span>
      </div>
      <div class="time" id="timerTime">00:00</div>
    </div>

    <div class="timerBtns">
      <button class="btn" id="btnStartStop">Iniciar</button>
      <button class="btn" id="btnPlus20">+20s</button>
      <button class="btn" id="btnPlus60">+60s</button>
      <button class="btn btnGhost" id="btnResetTimer">Fechar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Salvo ‚úÖ</div>

<!-- Bottom Nav -->
<nav class="nav">
  <button class="active" data-view="viewTreino"><span class="ico">üèãÔ∏è</span>Treino</button>
  <button data-view="viewMetricas"><span class="ico">üìä</span>M√©tricas</button>
  <button data-view="viewPeso"><span class="ico">‚öñÔ∏è</span>Peso</button>
  <button data-view="viewAjustes"><span class="ico">‚öôÔ∏è</span>Ajustes</button>
</nav>

<script>
/* =========================================================
   ‚úÖ Treino Tracker Modern
   - c√≥digo organizado por m√≥dulos
   - UI moderna + filtros + busca
   - progress√£o inteligente (sugest√£o)
   - streak (dias com treino)
   - timer melhor + presets
   ========================================================= */

/* =========================
   1) PLANO (o seu mesmo)
   ========================= */
const PLAN = {
  "Segunda": {
    title: "PUSH (Peito + Tr√≠ceps)",
    desc: "Foco em carga nos compostos e reps moderadas/altas nos isoladores. Ombro na m√°quina para completar.",
    exercises: [
      { name:"Supino inclinado", sets:4, repMin:6, repMax:8, restSec:180, note:"Composto pesado. T√©cnica e progress√£o." },
      { name:"Crucifixo na m√°quina", sets:3, repMin:10, repMax:12, restSec:75, note:"Controle e alongamento." },
      { name:"Paralelas", sets:3, repMin:8, repMax:12, restSec:120, note:"Quando bater 12 reps, aumenta carga." },
      { name:"Tr√≠ceps franc√™s", sets:3, repMin:8, repMax:10, restSec:90, note:"Amplitude, cotovelo est√°vel." },
      { name:"Extens√£o na polia (barra)", sets:3, repMin:12, repMax:15, restSec:75, note:"Finaliza√ß√£o, controle total." },
      { name:"Eleva√ß√£o na m√°quina (ombro)", sets:3, repMin:12, repMax:15, restSec:60, note:"Deltoide lateral gosta de reps." }
    ]
  },
  "Ter√ßa": {
    title: "PULL (Costas + B√≠ceps)",
    desc: "Costas com tens√£o mec√¢nica e boa execu√ß√£o. B√≠ceps com alongamento e controle.",
    exercises: [
      { name:"Puxada aberta na polia", sets:4, repMin:6, repMax:8, restSec:150, note:"Composto. Ombros longe das orelhas." },
      { name:"Pulldown com corda", sets:3, repMin:10, repMax:12, restSec:90, note:"Contra√ß√£o forte, sem roubo." },
      { name:"Remada aberta com halteres", sets:3, repMin:8, repMax:10, restSec:120, note:"Espessura. Tronco firme." },
      { name:"Rosca direta no banco inclinado", sets:3, repMin:8, repMax:10, restSec:90, note:"Alongamento m√°ximo." },
      { name:"Rosca Scott", sets:3, repMin:10, repMax:12, restSec:75, note:"Isolamento e controle." }
    ]
  },
  "Quarta": {
    title: "LEGS (Pernas completas)",
    desc: "Quadr√≠ceps com carga + volume. Posterior/abdutor/panturrilha com reps mais altas e controle.",
    exercises: [
      { name:"Agachamento no Smith", sets:4, repMin:6, repMax:8, restSec:180, note:"Controle na descida, foco no quad." },
      { name:"Leg press 45¬∞", sets:3, repMin:10, repMax:12, restSec:120, note:"Amplitude segura. N√£o trave joelhos." },
      { name:"Cadeira extensora", sets:3, repMin:12, repMax:15, restSec:75, note:"Segura 1s no topo." },
      { name:"Cadeira flexora", sets:3, repMin:10, repMax:12, restSec:90, note:"Posterior com controle." },
      { name:"Cadeira abdutora", sets:3, repMin:15, repMax:20, restSec:60, note:"Reps altas, movimento limpo." },
      { name:"Panturrilha em p√© na m√°quina", sets:4, repMin:8, repMax:12, restSec:75, note:"Pausa 1s no pico, des√ßa completo." },
      { name:"Panturrilha sentada na m√°quina", sets:3, repMin:12, repMax:20, restSec:60, note:"Alta repeti√ß√£o e controle." }
    ]
  },
  "Quinta": {
    title: "UPPER BODY (Parte superior)",
    desc: "Volume moderado para peito/costas/ombros. √ìtimo para frequ√™ncia e recupera√ß√£o.",
    exercises: [
      { name:"Supino inclinado", sets:3, repMin:8, repMax:10, restSec:120, note:"Moderado. T√©cnica perfeita." },
      { name:"Crucifixo", sets:3, repMin:12, repMax:15, restSec:75, note:"Metab√≥lico e controle." },
      { name:"Flex√£o pegada fechada", sets:3, repMin:12, repMax:20, restSec:60, note:"Chega perto da falha na √∫ltima." },
      { name:"Puxada unilateral", sets:3, repMin:10, repMax:12, restSec:90, note:"Sinta o dorsal." },
      { name:"Remada baixa", sets:3, repMin:8, repMax:10, restSec:120, note:"Espessura e esc√°pula controlada." },
      { name:"Desenvolvimento", sets:3, repMin:6, repMax:8, restSec:150, note:"Carga com controle. Sem dor." },
      { name:"Eleva√ß√£o lateral na polia", sets:3, repMin:12, repMax:15, restSec:60, note:"Reps e controle." }
    ]
  },
  "Sexta": {
    title: "POSTERIOR + Complementos",
    desc: "Posterior com tens√£o e alongamento. Completa com extensora, adutora e panturrilhas.",
    exercises: [
      { name:"Stiff", sets:4, repMin:6, repMax:8, restSec:180, note:"T√©cnico. Coluna neutra." },
      { name:"Cadeira flexora", sets:3, repMin:10, repMax:12, restSec:90, note:"Controle total." },
      { name:"Mesa flexora", sets:3, repMin:8, repMax:10, restSec:90, note:"For√ßa e contra√ß√£o." },
      { name:"Cadeira extensora", sets:3, repMin:12, repMax:15, restSec:75, note:"Manuten√ß√£o do quad." },
      { name:"Cadeira adutora", sets:3, repMin:15, repMax:20, restSec:60, note:"Reps altas e controle." },
      { name:"Panturrilha em p√©", sets:4, repMin:8, repMax:12, restSec:75, note:"Pausa no topo." },
      { name:"Panturrilha sentada", sets:3, repMin:15, repMax:20, restSec:60, note:"Alta repeti√ß√£o." }
    ]
  },
  "S√°bado": { title:"OFF / Recupera√ß√£o", desc:"Caminhada leve + mobilidade. Cresce no descanso.", exercises:[] },
  "Domingo": { title:"OFF / Recupera√ß√£o", desc:"Se quiser, cardio leve 15‚Äì25 min.", exercises:[] }
};

const DAY_ORDER = ["Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo"];

/* =========================
   2) Utils / DOM
   ========================= */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

const pad2 = (n)=> String(n).padStart(2,"0");
const isoToday = ()=>{
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
};
const formatDateBR = (iso)=>{
  const [y,m,d] = iso.split("-").map(Number);
  return `${pad2(d)}/${pad2(m)}/${y}`;
};
const dayNameFromDate = (dateObj)=>{
  const map = ["Domingo","Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado"];
  return map[dateObj.getDay()];
};
const fmtTime = (sec)=>{
  sec = Math.max(0, Math.floor(sec));
  const mm = String(Math.floor(sec/60)).padStart(2,"0");
  const ss = String(sec%60).padStart(2,"0");
  return `${mm}:${ss}`;
};
const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
const uid = ()=> Math.random().toString(16).slice(2) + Date.now().toString(16);
const safeCSV = (v)=>{
  const s = String(v ?? "");
  return /[",\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
};

function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"), 1200);
}

/* =========================
   3) Storage (v3)
   ========================= */
const STORAGE_KEY = "treino_tracker_v3_modern";

const State = {
  get(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return { logs: [], weights: [], ui: { filter:"all", search:"" } };
      const obj = JSON.parse(raw);
      obj.logs ??= [];
      obj.weights ??= [];
      obj.ui ??= { filter:"all", search:"" };
      return obj;
    }catch(e){
      return { logs: [], weights: [], ui: { filter:"all", search:"" } };
    }
  },
  set(st){ localStorage.setItem(STORAGE_KEY, JSON.stringify(st)); }
};

/* =========================
   4) Navigation
   ========================= */
function showView(viewId, btn){
  $$(".view").forEach(v => v.classList.remove("active"));
  $("#"+viewId).classList.add("active");
  $$(".nav button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");

  if(viewId === "viewMetricas"){ Metrics.render(); }
  if(viewId === "viewPeso"){ Weight.renderUI(); }
}
$$(".nav button").forEach(btn=>{
  btn.addEventListener("click", ()=> showView(btn.dataset.view, btn));
});

/* =========================
   5) Timer (better)
   ========================= */
const Timer = {
  running:false,
  remaining:0,
  interval:null,
  exercise:"",
  defaultRest:0,

  render(){
    $("#timerExercise").textContent = this.exercise ? `Descanso: ${this.exercise}` : "Descanso";
    $("#timerTime").textContent = fmtTime(this.remaining);
    $("#btnStartStop").textContent = this.running ? "Pausar" : "Iniciar";

    $("#timerHint").textContent = this.exercise
      ? `Sugest√£o: ${Math.round(this.defaultRest/60)} min. (+20s/+60s se precisar)`
      : "Quando voc√™ marcar uma s√©rie, o timer aparece aqui.";

    $("#timerDock").classList.toggle("show", !!this.exercise);
  },

  start(){
    if(this.running) return;
    this.running = true;
    this.interval = setInterval(()=>{
      this.remaining -= 1;
      if(this.remaining <= 0){
        this.remaining = 0;
        this.stop();
        toast("Descanso finalizado üîî");
      }
      this.render();
    }, 1000);
    this.render();
  },

  stop(){
    this.running = false;
    if(this.interval) clearInterval(this.interval);
    this.interval = null;
    this.render();
  },

  reset(toSec=null){
    this.stop();
    this.remaining = (toSec !== null) ? toSec : (this.defaultRest || 0);
    this.render();
  },

  add(sec){
    this.remaining += sec;
    this.render();
  },

  close(){
    this.exercise = "";
    this.defaultRest = 0;
    this.reset(0);
  }
};

$("#btnStartStop").addEventListener("click", ()=> Timer.running ? Timer.stop() : Timer.start());
$("#btnPlus20").addEventListener("click", ()=> Timer.add(20));
$("#btnPlus60").addEventListener("click", ()=> Timer.add(60));
$("#btnResetTimer").addEventListener("click", ()=> Timer.close());

/* =========================
   6) Workout module
   ========================= */
const Workout = {
  selectedDay: null,
  filter: "all",
  search: "",

  init(){
    const st = State.get();
    this.filter = st.ui?.filter ?? "all";
    this.search = st.ui?.search ?? "";
    $("#searchInput").value = this.search;

    // segmented filter restore
    $$("#segFilter button").forEach(b=>{
      b.classList.toggle("active", b.dataset.filter === this.filter);
    });

    $("#searchInput").addEventListener("input", ()=>{
      this.search = $("#searchInput").value.trim().toLowerCase();
      this.persistUI();
      this.render();
    });

    $("#segFilter").addEventListener("click", (ev)=>{
      const btn = ev.target.closest("button");
      if(!btn) return;
      this.filter = btn.dataset.filter;
      $$("#segFilter button").forEach(b=> b.classList.toggle("active", b === btn));
      this.persistUI();
      this.render();
    });

    $("#btnJumpToday").addEventListener("click", ()=>{
      this.jumpToToday();
      toast("Hoje ‚úÖ");
    });
  },

  persistUI(){
    const st = State.get();
    st.ui = { ...(st.ui||{}), filter: this.filter, search: this.search };
    State.set(st);
  },

  populateDaySelect(todayName){
    const sel = $("#daySelect");
    sel.innerHTML = "";
    DAY_ORDER.forEach(d=>{
      const opt = document.createElement("option");
      opt.value = d; opt.textContent = d;
      sel.appendChild(opt);
    });
    sel.value = this.selectedDay || todayName;
  },

  getLogsFor(dateISO, dayName, exName){
    const st = State.get();
    return st.logs
      .filter(l => l.dateISO === dateISO && l.dayName === dayName && l.exerciseName === exName)
      .sort((a,b)=> a.setIndex - b.setIndex);
  },

  latestForExercise(exName){
    const st = State.get();
    const logs = st.logs
      .filter(l => l.exerciseName === exName)
      .sort((a,b)=> b.createdAt - a.createdAt);
    return logs[0] || null;
  },

  // Smart suggestion: if last session hit top reps -> suggest +2.5% (rounded .5)
  suggestionFor(ex){
    const last = this.latestForExercise(ex.name);
    if(!last) return null;
    const hitTop = Number(last.reps) >= ex.repMax;
    if(!hitTop) return null;

    const inc = last.weight * 0.025;
    const suggested = Math.max(0, Math.round((last.weight + inc)*2)/2);
    return { last, suggested };
  },

  readInputsForSet(body, setIndex){
    const w = body.querySelector(`input[data-field="weight"][data-set="${setIndex}"]`);
    const r = body.querySelector(`input[data-field="reps"][data-set="${setIndex}"]`);
    return { weight: w ? Number(w.value) : NaN, reps: r ? Number(r.value) : NaN };
  },

  markSetDone(ex, setIndex, body){
    const { weight, reps } = this.readInputsForSet(body, setIndex);
    if(!Number.isFinite(weight) || weight <= 0) return toast("Coloque o peso ‚úÖ");
    if(!Number.isFinite(reps) || reps <= 0) return toast("Coloque as reps ‚úÖ");

    const st = State.get();
    const todayISO = isoToday();

    // upsert set log
    st.logs = st.logs.filter(l =>
      !(l.dateISO === todayISO && l.dayName === this.selectedDay && l.exerciseName === ex.name && l.setIndex === setIndex)
    );

    st.logs.push({
      id: uid(),
      dateISO: todayISO,
      dayName: this.selectedDay,
      workoutTitle: PLAN[this.selectedDay].title,
      exerciseName: ex.name,
      setIndex,
      weight,
      reps,
      targetText: `${ex.sets}x ${ex.repMin}‚Äì${ex.repMax}`,
      restSec: ex.restSec,
      createdAt: Date.now()
    });

    State.set(st);
    toast("S√©rie salva ‚úÖ");

    // timer
    Timer.exercise = ex.name;
    Timer.defaultRest = ex.restSec;
    Timer.reset(ex.restSec);
    Timer.start();

    this.render();
    Metrics.computeAndPaint();
  },

  copyLast(ex, body){
    const last = this.latestForExercise(ex.name);
    if(!last) return toast("Sem hist√≥rico");
    for(let i=1;i<=ex.sets;i++){
      const w = body.querySelector(`input[data-field="weight"][data-set="${i}"]`);
      const r = body.querySelector(`input[data-field="reps"][data-set="${i}"]`);
      if(w && !w.value) w.value = last.weight;
      if(r && !r.value) r.value = last.reps;
    }
    toast("Preenchido ‚úÖ");
  },

  clearToday(ex){
    const st = State.get();
    const todayISO = isoToday();
    const before = st.logs.length;
    st.logs = st.logs.filter(l =>
      !(l.dateISO === todayISO && l.dayName === this.selectedDay && l.exerciseName === ex.name)
    );
    State.set(st);
    toast(before !== st.logs.length ? "Hoje limpo" : "Nada p/ apagar");
    this.render();
    Metrics.computeAndPaint();
  },

  jumpToToday(){
    const todayName = dayNameFromDate(new Date());
    this.selectedDay = todayName;
    $("#daySelect").value = todayName;
    this.render();
    $("#workoutPill").textContent = PLAN[this.selectedDay].title;
  },

  render(){
    const todayISO = isoToday();
    const plan = PLAN[this.selectedDay];

    $("#pillTitle").textContent = plan.title;
    $("#workoutPill").textContent = plan.title;
    $("#dayDesc").textContent = plan.desc;

    const container = $("#workoutList");
    container.innerHTML = "";

    if(!plan.exercises.length){
      container.innerHTML = `
        <div class="hint">
          <b>${plan.title}</b><br>
          ${plan.desc}
        </div>
      `;
      Side.paint();
      return;
    }

    // apply search and filter
    const all = plan.exercises.slice();
    const filtered = all.filter(ex=>{
      const matchSearch = !this.search || ex.name.toLowerCase().includes(this.search);
      if(!matchSearch) return false;

      if(this.filter === "all") return true;

      const doneLogs = this.getLogsFor(todayISO, this.selectedDay, ex.name);
      const doneCount = doneLogs.length;

      if(this.filter === "pending") return doneCount < ex.sets;
      if(this.filter === "done") return doneCount >= ex.sets;
      return true;
    });

    if(!filtered.length){
      container.innerHTML = `
        <div class="hint">
          <b>Nada encontrado</b><br>
          Ajuste a busca ou volte o filtro para <b>Tudo</b>.
        </div>
      `;
      Side.paint();
      return;
    }

    filtered.forEach(ex=>{
      const details = document.createElement("details");
      details.className = "exercise";

      const last = this.latestForExercise(ex.name);
      const lastStr = last ? `${last.weight}kg x ${last.reps} (${formatDateBR(last.dateISO)})` : "sem hist√≥rico";

      const doneLogs = this.getLogsFor(todayISO, this.selectedDay, ex.name);
      const doneCount = doneLogs.length;

      const statusChip = doneCount >= ex.sets
        ? `<span class="chip ok">‚úÖ ${doneCount}/${ex.sets}</span>`
        : `<span class="chip warn">‚è≥ ${doneCount}/${ex.sets}</span>`;

      const suggestion = this.suggestionFor(ex);
      const suggestChip = suggestion
        ? `<span class="chip">‚¨ÜÔ∏è Sug: ${suggestion.suggested}kg</span>`
        : ``;

      const summary = document.createElement("summary");
      summary.innerHTML = `
        <div class="sumLeft">
          <div class="exName">${ex.name}</div>
          <div class="exMeta">Alvo: <b>${ex.sets}x ${ex.repMin}‚Äì${ex.repMax}</b> ‚Ä¢ Descanso: <b>${Math.round(ex.restSec/60)} min</b></div>
        </div>
        <div class="sumRight">
          ${statusChip}
          <span class="chip">${lastStr}</span>
          ${suggestChip}
        </div>
      `;
      details.appendChild(summary);

      const body = document.createElement("div");
      body.className = "exBody";

      for(let i=1;i<=ex.sets;i++){
        const prev = doneLogs.find(l => l.setIndex === i) || null;
        const row = document.createElement("div");
        row.className = "setRow";
        row.innerHTML = `
          <div class="setLabel">#${i}</div>
          <div>
            <input type="number" step="0.5" min="0" inputmode="decimal" placeholder="Peso (kg)"
              data-field="weight" data-set="${i}" value="${prev ? prev.weight : ""}">
          </div>
          <div>
            <input type="number" step="1" min="0" inputmode="numeric" placeholder="Reps"
              data-field="reps" data-set="${i}" value="${prev ? prev.reps : ""}">
          </div>
          <div style="text-align:right">
            <button class="btn ${prev ? "btnPrimary" : ""}" data-action="done" data-set="${i}">
              ${prev ? "Feito ‚úÖ" : "Marcar"}
            </button>
          </div>
        `;
        body.appendChild(row);
      }

      const hint = document.createElement("div");
      hint.className = "hint";
      hint.innerHTML = `
        <b>Objetivo</b><br>
        ${ex.note}<br>
        <span class="small">Natural: falha s√≥ na √∫ltima s√©rie. Antes disso, pare com 1‚Äì2 reps na reserva.</span>
      `;

      const actions = document.createElement("div");
      actions.className = "twoBtn";
      actions.innerHTML = `
        <button class="btn" data-action="copyLast">Usar √∫ltimo peso/reps</button>
        <button class="btn btnDanger" data-action="clearToday">Limpar hoje</button>
      `;

      body.appendChild(hint);
      body.appendChild(actions);

      body.addEventListener("click", (ev)=>{
        const btn = ev.target.closest("button");
        if(!btn) return;
        const action = btn.dataset.action;

        if(action === "done"){
          const setIndex = Number(btn.dataset.set);
          this.markSetDone(ex, setIndex, body);
        }
        if(action === "copyLast") this.copyLast(ex, body);
        if(action === "clearToday") this.clearToday(ex);
      });

      details.appendChild(body);
      container.appendChild(details);
    });

    Side.paint();
  }
};

/* =========================
   7) Metrics module
   ========================= */
const Metrics = {
  compute(){
    const st = State.get();
    const todayISO = isoToday();
    const todayLogs = st.logs.filter(l => l.dateISO === todayISO);

    const setsToday = todayLogs.length;
    let tonnage = 0;
    todayLogs.forEach(l => tonnage += (Number(l.weight)||0) * (Number(l.reps)||0));

    const last = st.logs.slice().sort((a,b)=> b.createdAt - a.createdAt)[0] || null;

    return { setsToday, tonnage: Math.round(tonnage), last };
  },

  computeAndPaint(){
    const { setsToday, tonnage, last } = this.compute();
    $("#kpiSetsToday").textContent = String(setsToday);
    $("#kpiTonnageToday").textContent = String(tonnage);
    $("#kpiLastLog").textContent = last ? `${last.exerciseName} (${last.weight}kg x ${last.reps})` : "Nenhum";
    Streak.paint();
    Side.paint();
    this.paintProgressHint();
  },

  paintProgressHint(){
    // show one useful suggestion based on last logs in selected day (if any)
    const plan = PLAN[Workout.selectedDay];
    const best = plan.exercises
      .map(ex => ({ ex, s: Workout.suggestionFor(ex) }))
      .find(x => x.s);

    $("#progressHint").innerHTML = best
      ? `<b>Progress√£o sugerida</b><br>Em <b>${best.ex.name}</b>, voc√™ bateu reps altas. Pr√≥xima: tente <b>${best.s.suggested}kg</b> (aprox. +2,5%).`
      : `<b>Progress√£o inteligente</b><br>Quando voc√™ bater o topo da faixa de reps com boa t√©cnica, suba 2‚Äì5% na pr√≥xima sess√£o.`;
  },

  renderHistory(){
    const st = State.get();
    const logs = st.logs.slice().sort((a,b)=> b.createdAt - a.createdAt).slice(0, 12);
    const el = $("#history");

    if(!logs.length){
      el.innerHTML = `<div class="hint">Sem registros ainda. Marque uma s√©rie como feita no Treino.</div>`;
      return;
    }

    const rows = logs.map(l => `
      <tr>
        <td>${formatDateBR(l.dateISO)}</td>
        <td>${l.dayName}</td>
        <td>${l.exerciseName}</td>
        <td style="font-family:var(--mono);font-weight:950">#${l.setIndex}</td>
        <td>${l.weight}</td>
        <td>${l.reps}</td>
      </tr>
    `).join("");

    el.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Data</th><th>Dia</th><th>Exerc√≠cio</th><th>S√©rie</th><th>Peso</th><th>Reps</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  },

  render(){
    this.computeAndPaint();
    this.renderHistory();
  }
};

/* =========================
   8) Weight module
   ========================= */
const Weight = {
  isFriday(dateObj){ return dateObj.getDay() === 5; },

  renderUI(){
    const today = new Date();
    const friday = this.isFriday(today);
    $("#pesoHintPill").textContent = friday ? "Hoje √© sexta ‚úÖ" : "Sexta";
    $("#pesoHintText").textContent = friday
      ? "Boa! Registre seu peso semanal hoje."
      : "Registrar 1x por semana, toda sexta-feira (mas voc√™ pode registrar quando quiser).";
    this.renderHistory();
  },

  renderHistory(){
    const st = State.get();
    const logs = st.weights.slice().sort((a,b)=> b.createdAt - a.createdAt).slice(0, 12);
    const el = $("#weightHistory");

    if(!logs.length){
      el.innerHTML = `<div class="hint">Sem registros de peso ainda.</div>`;
      return;
    }

    const rows = logs.map(w => `
      <tr>
        <td>${formatDateBR(w.dateISO)}</td>
        <td style="font-family:var(--mono);font-weight:950">${w.weightKg}</td>
      </tr>
    `).join("");

    el.innerHTML = `
      <table>
        <thead><tr><th>Data</th><th>Peso (kg)</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  },

  save(){
    const value = Number($("#weightInput").value);
    if(!Number.isFinite(value) || value <= 0) return toast("Digite um peso v√°lido ‚úÖ");

    const st = State.get();
    const todayISO = isoToday();

    st.weights = st.weights.filter(w => w.dateISO !== todayISO);
    st.weights.push({
      id: uid(),
      dateISO: todayISO,
      weightKg: Number(value.toFixed(1)),
      createdAt: Date.now()
    });

    State.set(st);
    $("#weightInput").value = "";
    toast("Peso salvo ‚úÖ");
    this.renderHistory();
  },

  exportCSV(){
    const st = State.get();
    const items = st.weights.slice().sort((a,b)=> a.createdAt - b.createdAt);
    if(!items.length) return toast("Sem peso p/ exportar");

    const header = ["data","peso_kg"];
    const lines = [header.join(",")];
    items.forEach(w=> lines.push([w.dateISO, w.weightKg].join(",")));

    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `peso_${isoToday()}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("CSV (peso) ‚úÖ");
  }
};

$("#btnSaveWeight").addEventListener("click", ()=> Weight.save());
$("#btnExportWeight").addEventListener("click", ()=> Weight.exportCSV());

/* =========================
   9) Export / Backup / Import / Reset
   ========================= */
function exportWorkoutCSV(){
  const st = State.get();
  const logs = st.logs.slice().sort((a,b)=> a.createdAt - b.createdAt);
  if(!logs.length) return toast("Nada p/ exportar");

  const header = ["data","dia","treino","exercicio","serie","peso_kg","reps","alvo","descanso_seg"];
  const lines = [header.join(",")];

  logs.forEach(l=>{
    lines.push([
      l.dateISO,
      safeCSV(l.dayName),
      safeCSV(l.workoutTitle),
      safeCSV(l.exerciseName),
      l.setIndex,
      l.weight,
      l.reps,
      safeCSV(l.targetText),
      l.restSec
    ].join(","));
  });

  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `treino_logs_${isoToday()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("CSV (treino) ‚úÖ");
}
$("#btnExport").addEventListener("click", exportWorkoutCSV);
$("#btnExportFromMetrics").addEventListener("click", exportWorkoutCSV);
$("#btnQuickExport").addEventListener("click", exportWorkoutCSV);

function backupJSON(){
  const st = State.get();
  const blob = new Blob([JSON.stringify(st, null, 2)], { type:"application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `backup_treino_${isoToday()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("Backup ‚úÖ");
}
$("#btnBackup").addEventListener("click", backupJSON);
$("#btnBackup2").addEventListener("click", backupJSON);

function importJSON(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      if(!obj || (!Array.isArray(obj.logs) && !Array.isArray(obj.weights))) throw new Error("Formato inv√°lido");

      const merged = {
        logs: Array.isArray(obj.logs) ? obj.logs : [],
        weights: Array.isArray(obj.weights) ? obj.weights : [],
        ui: obj.ui || { filter:"all", search:"" }
      };

      State.set(merged);
      toast("Importado ‚úÖ");
      App.renderAll();
    }catch(e){
      toast("Falha ‚ùå");
      alert("Arquivo inv√°lido. Use um backup gerado pelo pr√≥prio site.");
    }
  };
  reader.readAsText(file);
}
$("#importFile").addEventListener("change", (ev)=>{
  const file = ev.target.files?.[0];
  if(file) importJSON(file);
  ev.target.value = "";
});
$("#importFile2").addEventListener("change", (ev)=>{
  const file = ev.target.files?.[0];
  if(file) importJSON(file);
  ev.target.value = "";
});

function resetAll(){
  if(!confirm("Apagar tudo? Isso remove registros do navegador.")) return;
  localStorage.removeItem(STORAGE_KEY);
  Timer.close();
  toast("Reset ‚úÖ");
  App.renderAll();
}
$("#btnReset").addEventListener("click", resetAll);
$("#btnReset2").addEventListener("click", resetAll);

/* =========================
   10) Streak + Side panel
   ========================= */
const Streak = {
  daysWithTraining(){
    const st = State.get();
    const unique = new Set(st.logs.map(l => l.dateISO));
    return [...unique].sort(); // ascending
  },
  computeCurrent(){
    const days = this.daysWithTraining();
    if(!days.length) return 0;

    // count backwards from today while consecutive
    const toDate = (iso)=> new Date(iso+"T00:00:00");
    const today = toDate(isoToday());
    const set = new Set(days);

    let count = 0;
    for(let i=0;i<3650;i++){
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      const iso = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      if(set.has(iso)) count++;
      else break;
    }
    return count;
  },
  paint(){
    const c = this.computeCurrent();
    $("#streakPill").textContent = `üî• ${c} dia${c===1?"":"s"}`;
  }
};

const Side = {
  paint(){
    const todayISO = isoToday();
    const st = State.get();

    const plan = PLAN[Workout.selectedDay];
    const planned = plan.exercises.reduce((acc, ex)=> acc + ex.sets, 0);
    const done = st.logs.filter(l => l.dateISO === todayISO && l.dayName === Workout.selectedDay).length;

    $("#kpiProgress").textContent = `${done}/${planned || 0}`;
    $("#todaySummaryPill").textContent = `${Workout.selectedDay} ‚Ä¢ ${plan.title}`;

    // rest estimate: average rest for planned exercises
    const rests = plan.exercises.map(e=> e.restSec || 0).filter(Boolean);
    const avg = rests.length ? Math.round(rests.reduce((a,b)=>a+b,0)/rests.length) : 0;
    $("#kpiRest").textContent = avg ? `${Math.round(avg/60)} min (m√©dia)` : "‚Äî";

    // micro tip context-aware
    $("#sideTip").innerHTML = done >= planned && planned > 0
      ? `<b>Fechou o treino ‚úÖ</b><br>Hidrate, coma bem e registre o peso na sexta. O corpo aprende no descanso.`
      : `<b>Dica r√°pida</b><br>Marque uma s√©rie e o timer aparece. Se a t√©cnica cair, mantenha reps e refine a execu√ß√£o.`;
  }
};

/* =========================
   11) App init + shortcuts
   ========================= */
const App = {
  renderAll(){
    const today = new Date();
    const todayName = dayNameFromDate(today);
    const todayISO = isoToday();

    if(!Workout.selectedDay) Workout.selectedDay = todayName;

    $("#todayPill").textContent = `${todayName} ‚Ä¢ ${formatDateBR(todayISO)}`;

    Workout.populateDaySelect(todayName);
    Workout.render();
    Metrics.computeAndPaint();
    Metrics.renderHistory();
    Weight.renderUI();
    Timer.render();
    Streak.paint();
  },

  init(){
    Workout.init();

    $("#daySelect").addEventListener("change", ()=>{
      Workout.selectedDay = $("#daySelect").value;
      Workout.render();
      $("#workoutPill").textContent = PLAN[Workout.selectedDay].title;
      Metrics.computeAndPaint();
    });

    // keyboard shortcuts (desktop)
    window.addEventListener("keydown", (ev)=>{
      if(ev.key === "/" && document.activeElement?.tagName !== "INPUT"){
        ev.preventDefault();
        $("#searchInput").focus();
      }
      if(ev.key.toLowerCase() === "t") this.navTo("viewTreino");
      if(ev.key.toLowerCase() === "m") this.navTo("viewMetricas");
      if(ev.key.toLowerCase() === "p") this.navTo("viewPeso");
    });

    this.renderAll();
  },

  navTo(viewId){
    const btn = $(`.nav button[data-view="${viewId}"]`);
    if(btn) showView(viewId, btn);
  }
};

App.init();
</script>
</body>
</html>
